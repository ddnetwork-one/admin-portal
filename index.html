<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal v12.2 (Pending Edits Workflow)</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            /* Developer Dark Theme */
            --bg-app: #050505; 
            --bg-sidebar: #0a0a0c;
            --bg-surface: #0f0f12; 
            --bg-surface-hover: #18181b;
            --bg-input: #121214;
            
            --border: #27272a;
            --border-active: #3f3f46;
            --border-light: rgba(255,255,255,0.08);

            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --text-faint: #52525b;

            /* Accents */
            --primary: #3b82f6; /* Electric Blue */
            --primary-hover: #2563eb;
            --primary-glow: rgba(59, 130, 246, 0.2);
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ticket: #8b5cf6; 
            --info: #0ea5e9;
            
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 70px;
            --header-height: 64px;

            /* Z-Index Layers */
            --z-base: 1;
            --z-sidebar: 100;
            --z-header: 200;
            --z-dropdown: 300;
            --z-modal-overlay: 1000;
            --z-modal-content: 1010;
            --z-toast: 2000;
        }

        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg-app); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }
        
        /* UTILITIES */
        .hidden { display: none !important; }
        .flex { display: flex; } 
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; } 
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } 
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.85rem; }
        .font-bold { font-weight: 700; }
        .text-muted { color: var(--text-muted); }
        .block { display: block; }
        
        /* Monospace font for IDs/Code */
        .font-mono { font-family: var(--font-mono); letter-spacing: -0.5px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius:4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* BUTTONS */
        .btn {
            padding: 0.6rem 1.2rem; 
            border-radius: 6px; 
            border:1px solid transparent; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 0.85rem; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
            color: var(--text-main);
            background: var(--bg-surface-hover);
            position: relative;
            overflow: hidden;
        }
        .btn:hover { 
            background: #2a2a35;
            border-color: var(--border-active);
            transform: translateY(-1px);
        }
        .btn:active { transform: translateY(0); }

        .btn-primary { 
            background: var(--primary); 
            color: white; 
            border:1px solid var(--primary); 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); 
        }
        .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }

        .btn-success { background: rgba(16, 185, 129, 0.1); color: var(--success); border:1px solid rgba(16, 185, 129, 0.2); }
        .btn-success:hover { background: rgba(16, 185, 129, 0.2); border-color: var(--success); }

        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border:1px solid rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); }
        
        .btn-danger-solid { background: var(--danger); color: white; border:1px solid var(--danger); }
        .btn-danger-solid:hover { background: #dc2626; }

        .btn-info { background: rgba(14, 165, 233, 0.1); color: var(--info); border:1px solid rgba(14, 165, 233, 0.2); }
        .btn-info:hover { background: rgba(14, 165, 233, 0.2); border-color: var(--info); }

        .btn-secondary { background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--text-muted); background: var(--bg-surface-hover); }
        
        .btn-sm { padding: 0.35rem 0.8rem; font-size: 0.75rem; border-radius: 4px; }
        
        .btn-icon { 
            padding: 0.5rem; 
            border-radius: 6px; 
            background: transparent; 
            color: var(--text-muted); 
            cursor: pointer; 
            border: none; 
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px;
        }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.05); }
        .btn-icon.spin:hover i { animation: spin 1s linear infinite; }

        /* FORMS */
        input, select, textarea {
            width:100%; 
            padding: 0.65rem 0.85rem; 
            background: var(--bg-input); 
            border:1px solid var(--border); 
            border-radius: 6px; 
            color: white; 
            font-family: inherit; 
            font-size: 0.9rem; 
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); 
            background: #000;
        }
        input[readonly], textarea[readonly] { 
            background: #141414; 
            cursor: default; 
            border-color: transparent; 
            color: var(--text-muted); 
        }
        label { display: block; margin-bottom: 0.4rem; color: var(--text-muted); font-size: 0.75rem; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }

        /* AUTH SCREEN */
        #auth-screen { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 50% 50%, #1e1e24 0%, #000 100%); 
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding:1rem;
        }
        .auth-card { 
            width: 100%; max-width: 400px; 
            padding: 2.5rem; 
            background: rgba(18, 18, 22, 0.8); 
            backdrop-filter: blur(20px);
            border-radius: 16px; 
            border:1px solid var(--border); 
            text-align: center; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
        }
        .auth-card img { height: 50px; margin-bottom: 1.5rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }

        /* LAYOUT STRUCTURE */
        #dashboard { display: flex; width: 100%; height: 100vh; overflow: hidden; position: relative; }
        
        /* SIDEBAR OVERLAY (Mobile) */
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            z-index: var(--z-sidebar); opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* SIDEBAR */
        aside { 
            width: var(--sidebar-width); 
            background: var(--bg-sidebar); 
            border-right:1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: var(--z-sidebar); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed; top: var(--header-height); bottom: 0; left: 0;
        }

        /* DESKTOP COLLAPSED STATE */
        aside.collapsed {
            width: var(--sidebar-width-collapsed);
        }
        aside.collapsed .nav-text, 
        aside.collapsed .nav-section-title, 
        aside.collapsed .u-details, 
        aside.collapsed .user-mini-profile p {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        aside.collapsed .nav-item {
            padding: 0.8rem 0;
            justify-content: center;
        }
        aside.collapsed .nav-item i {
            font-size: 1.4rem;
            margin: 0;
        }
        aside.collapsed .header-brand span {
            display: none;
        }
        aside.collapsed .btn-danger span {
            display: none;
        }
        aside.collapsed .user-mini-profile {
            padding: 1rem 0;
            justify-content: center;
        }

        /* HEADER */
        header {
            height: var(--header-height);
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(12px);
            border-bottom:1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: fixed; top: 0; left: 0; right: 0;
            z-index: var(--z-header);
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-brand { font-weight: 700; font-size: 1rem; color: white; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .header-brand img { height: 24px; filter: brightness(0) invert(1); }
        .header-actions { display: flex; align-items: center; gap: 0.25rem; position: relative; height: 100%; }
        
        .notification-dot { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-sidebar); pointer-events: none; z-index: 10; }
        
        .notif-dropdown {
            position: absolute; top: 70px; right: 10px; width: 320px;
            background: var(--bg-surface); border:1px solid var(--border);
            border-radius: 12px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            display: none; flex-direction: column; padding: 0;
            z-index: var(--z-dropdown); 
            max-height: 400px; overflow-y: auto;
            transform-origin: top right;
            animation: fadeIn 0.15s ease;
        }
        .notif-dropdown.show { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .notif-item { padding: 0.9rem 1.2rem; border-bottom: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .notif-item:hover { background: rgba(255,255,255,0.03); }
        .notif-item strong { color: white; display: block; margin-bottom: 2px; font-size: 0.85rem; }
        .notif-item div { color: var(--text-muted); font-size: 0.8rem; line-height: 1.4; }
        .notif-time { font-size: 0.7rem; color: var(--text-faint); margin-top: 4px; display: block; }

        /* Sidebar Navigation */
        .user-mini-profile { padding: 1.25rem; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.01); display: flex; align-items: center; gap: 12px; }
        .u-info { display: flex; align-items: center; gap: 12px; width: 100%; }
        .u-avatar { 
            width: 40px; height: 40px; 
            background: linear-gradient(135deg, var(--primary), #6366f1); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
            font-size: 1.1rem; 
            color: white; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            flex-shrink: 0;
        }
        .u-details h4 { font-size: 0.9rem; color: white; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .u-details p { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }

        .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-section-title { 
            padding: 1rem 1.5rem 0.5rem; 
            font-size: 0.65rem; 
            color: var(--text-faint); 
            text-transform: uppercase; 
            font-weight: 700; 
            letter-spacing: 1px; 
        }
        .nav-item { 
            padding: 0.7rem 1.5rem; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: 0.2s; 
            border-left: 3px solid transparent; 
            font-weight: 500;
            margin-right: 0.5rem;
            border-radius: 0 6px 6px 0;
            position: relative;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent); 
            color: var(--primary); 
            border-left-color: var(--primary); 
            font-weight: 600;
        }
        .nav-item i { font-size: 1.15rem; }

        /* MAIN CONTENT */
        main { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            background: var(--bg-app); 
            padding: 2rem; 
            position: relative; 
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
            width: 100%;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* DASHBOARD CARDS */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 1.25rem; 
            margin-bottom: 2.5rem; 
        }
        .stat-card { 
            background: var(--bg-surface); 
            padding: 1.5rem; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 1.2rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--border-active); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .stat-icon { 
            width: 48px; height: 48px; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.03); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.4rem; 
            color: var(--text-main);
        }
        .stat-info { display: flex; flex-direction: column; }
        .stat-val { font-size: 1.6rem; font-weight: 700; color: white; line-height: 1.1; margin-bottom: 4px; letter-spacing: -1px; }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* LIST GROUP */
        .list-group { background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); padding: 1.5rem; }
        .list-group h3 { font-size: 1rem; font-weight: 600; margin-bottom:1.2rem; display: flex; justify-content: space-between; align-items: center; color: white; }
        .activity-item { display: flex; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .activity-item:last-child { border: none; }
        .activity-icon { width: 32px; height: 32px; border-radius: 8px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
        .activity-content h5 { font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 2px; }
        .activity-content p { font-size: 0.75rem; color: var(--text-muted); }
        .activity-time { margin-left: auto; font-size: 0.7rem; color: var(--text-faint); white-space: nowrap; }

        /* TABLES */
        .table-container { 
            background: var(--bg-surface); 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            overflow: hidden; 
            margin-bottom: 2rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .table-header { 
            padding: 1.2rem 1.5rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255,255,255,0.02); 
            flex-wrap: wrap; gap: 10px;
        }
        .table-header h3 { font-size: 0.95rem; font-weight: 600; color: white; letter-spacing: -0.3px; }
        .table-responsive { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { 
            text-align: left; 
            padding: 0.8rem 1.2rem; 
            color: var(--text-muted); 
            font-size: 0.7rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            background: rgba(0,0,0,0.3); 
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            letter-spacing: 0.5px;
        }
        td { padding: 1rem 1.2rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.85rem; vertical-align: middle; transition: 0.1s; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* --- ACCESS DENIED PAGE --- */
        .access-denied-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
        }
        .access-denied-icon {
            font-size: 4rem;
            color: var(--danger);
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        .access-denied-title {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 0.5rem;
        }
        .access-denied-desc {
            font-size: 1rem;
            max-width: 400px;
            line-height: 1.5;
            margin-bottom: 2rem;
        }

        /* --- MAIN MODAL --- */
        .modal-overlay { 
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(8px); 
            z-index: var(--z-modal-overlay); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        .modal { 
            background: var(--bg-surface); 
            width: 100%; 
            max-width: 520px; 
            border-radius: 16px; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .modal-header { 
            padding: 1.25rem 1.5rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255,255,255,0.02); 
            border-radius: 16px 16px 0 0; 
            flex-shrink: 0;
        }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: white; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.2rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; border-radius: 0 0 16px 16px; background: rgba(0,0,0,0.2); flex-shrink: 0; }

        /* --- INVOICE MODAL STYLES --- */
        #invoiceModalOverlay {
            z-index: 3000;
            background: rgba(0, 0, 0, 0.95); 
            padding: 0;
        }
        
        .invoice-modal-wrapper {
            width: 100%;
            height: 100%;
            display: grid;
            place-items: center; 
            justify-items: center;
            overflow-y: auto; 
            padding: 20px; 
        }

        .invoice-paper {
            background: white;
            color: #1f2937;
            width: 210mm; 
            min-height: 297mm; 
            padding: 15mm;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.92); 
            transform-origin: top center; 
            margin: 0; 
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }

        .inv-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
        .inv-logo-area h1 { color: #0f172a; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 4px; }
        .inv-logo-area p { color: #64748b; font-size: 13px; }
        .inv-title-area { text-align: right; }
        .inv-title-area h2 { font-size: 32px; color: #1e293b; font-weight: 700; margin: 0; }
        .inv-meta { margin-top: 10px; font-size: 13px; color: #475569; }
        .inv-meta strong { color: #1e293b; }

        .inv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .inv-section-title { font-size: 12px; text-transform: uppercase; color: #94a3b8; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 8px; }
        .inv-box h3 { font-size: 16px; font-weight: 600; color: #0f172a; margin-bottom: 4px; }
        .inv-box p { color: #334155; font-size: 13px; margin-bottom: 2px; }

        .inv-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; border-radius: 4px; overflow: hidden; table-layout: fixed; }
        .inv-table th { text-align: left; padding: 14px 16px; background: #f8fafc; color: #475569; font-size: 12px; text-transform: uppercase; font-weight: 600; border-bottom: 2px solid #e2e8f0; letter-spacing: 0.5px; white-space: normal; vertical-align: middle; }
        .inv-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: top; line-height: 1.6; white-space: normal; word-wrap: break-word; }
        
        .inv-table th:nth-child(1), .inv-table td:nth-child(1) { width: 55%; text-align: left; }
        .inv-table th:nth-child(2), .inv-table td:nth-child(2) { width: 15%; text-align: center; }
        .inv-table th:nth-child(3), .inv-table td:nth-child(3) { width: 30%; text-align: right; }
        
        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }
        
        .inv-total-section { display: flex; justify-content: flex-end; margin-bottom: 40px; }
        .inv-total-box { width: 250px; }
        .inv-total-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; color: #475569; }
        .inv-total-row.final { border-bottom: none; border-top: 2px solid #e2e8f0; padding-top: 16px; margin-top: 8px; font-weight: 700; color: #0f172a; font-size: 18px; }

        .inv-bank-details { background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .inv-bank-title { font-size: 14px; font-weight: 600; color: #0f172a; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .inv-bank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 13px; color: #334155; }
        .inv-bank-item strong { display: block; color: #64748b; font-size: 11px; margin-bottom: 2px; }

        .inv-footer { text-align: center; color: #94a3b8; font-size: 12px; margin-top: auto; padding-top: 20px; border-top: 1px dashed #e2e8f0; }

        .invoice-controls {
            position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 3001; background: rgba(15, 23, 42, 0.9); padding: 8px; border-radius: 12px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* --- Multi Select Styles --- */
        .multi-select-container {
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            max-height: 150px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: rgba(255,255,255,0.05); }
        .checkbox-item input { width: auto; margin: 0; }
        .checkbox-item span { font-size: 0.9rem; color: var(--text-main); }

        /* APPROVAL BADGE */
        .req-approval-badge {
            display: inline-flex; align-items: center; gap:4px;
            background: rgba(245, 158, 11, 0.15); color: var(--warning);
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(245, 158, 11, 0.2);
            margin-left: 8px;
        }
        
        /* DIFF VIEWER (For Approvals) */
        .diff-viewer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .diff-col {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .diff-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--text-faint);
            margin-bottom: 0.5rem;
        }
        .diff-field {
            font-size: 0.85rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .diff-field.old {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .diff-field.new {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* RESPONSIVENESS */
        @media(max-width: 1024px) {
            aside { transform: translateX(-100%); width: 280px; box-shadow: 20px 0 40px rgba(0,0,0,0.5); }
            aside.mobile-open { transform: translateX(0); }
            main { margin-left: 0 !important; width: 100% !important; padding: 1.5rem; padding-top: 5rem; }
            .stats-grid { grid-template-columns:1fr; }
            .price-grid { grid-template-columns:1fr; }
            .header-brand span { display: none; }
            .notif-dropdown { right: 0; width: 90vw; }
            
            .invoice-paper { transform: scale(0.75); }
            .inv-grid { grid-template-columns: 1fr; gap: 20px; }
            .inv-bank-grid { grid-template-columns: 1fr; }
            .inv-table th, .inv-table td { padding: 10px; font-size: 12px; }
            
            .inv-table th:nth-child(1), .inv-table td:nth-child(1) { width: 50%; }
            .inv-table th:nth-child(2), .inv-table td:nth-child(2) { width: 20%; }
            .inv-table th:nth-child(3), .inv-table td:nth-child(3) { width: 30%; }
            
            .diff-viewer { grid-template-columns: 1fr; }
        }
        
        @media(min-width: 1025px) and (max-width: 1440px) {
            .invoice-paper { transform: scale(0.85); }
        }

        @media print {
            body { background-color: white !important; color: black !important; height: auto; width: 100%; overflow: visible; display: block; }
            body > *:not(#invoiceModalOverlay) { display: none !important; }
            #invoiceModalOverlay { position: static !important; background-color: white !important; height: auto; width: 100%; z-index: 999999; overflow: visible; display: block !important; padding: 0 !important; }
            .invoice-modal-wrapper { display: block; height: auto; overflow: visible; }
            .invoice-paper { position: static; margin: 0 auto; padding: 0; width: 100%; box-shadow: none; border: none; color: black !important; background: white !important; transform: none !important; transform-origin: initial !important; margin-bottom: 0 !important; min-height: auto !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .invoice-controls { display: none !important; }
            @page { size: A4; margin: 0; }
        }

        /* TOAST */
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: var(--z-toast); display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: var(--bg-surface); 
            color: white; 
            padding:1rem 1.25rem; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.6); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transform: translateX(120%); 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            min-width: 300px; pointer-events: auto;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }

        /* Badges */
        .badge { padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; display: inline-block; letter-spacing: 0.3px; }
        .badge-admin { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-crew { background: rgba(59, 130, 246, 0.15); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.2); }
        .badge-user { background: rgba(255,255,255,0.1); color: white; }
        .badge-voucher { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        
        /* Request Badges */
        .badge-content { background: rgba(14, 165, 233, 0.15); color: var(--info); border: 1px solid rgba(14, 165, 233, 0.2); }
        .badge-upgrade { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-renew { background: rgba(139, 92, 246, 0.15); color: var(--ticket); border: 1px solid rgba(139, 92, 246, 0.2); }
        .badge-remove { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

        /* CONFIG TAB SPECIFICS */
        .config-section { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .config-header { font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); transition: .4s; border-radius: 34px; border: 1px solid var(--border); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); border-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .gateway-card { background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 0.5rem; }

        /* Loading State */
        .loading-spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page-loader { display: flex; justify-content: center; align-items: center; height: 300px; width: 100%; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/ddnetwork/refs/heads/main/DDN%20Logo%20NoBG.png" alt="Logo">
            <h2 class="mb-4" style="color:white; font-weight: 700; letter-spacing: -0.5px;">Admin Portal v12.2</h2>
            <form id="loginForm">
                <input type="text" id="loginInput" class="mb-4" placeholder="Email or Crew ID" required>
                <input type="password" id="loginPass" class="mb-4" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Secure Login</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- GLOBAL HEADER -->
        <header>
            <div class="header-left">
                <button class="btn-icon" onclick="toggleSidebar()" title="Toggle Menu"><i class="ri-menu-line" style="font-size: 1.4rem;"></i></button>
                <div class="header-brand">
                    <img src="https://raw.githubusercontent.com/ddnetwork-ent/ddnetwork/refs/heads/main/DDN%20Logo%20NoBG.png">
                    <span>DDN v12.2</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon spin" onclick="location.reload()" title="Force Refresh"><i class="ri-refresh-line"></i></button>
                
                <!-- Notifications -->
                <button class="btn-icon" id="notif-btn" onclick="toggleNotifications()">
                    <i class="ri-notification-3-line" style="font-size: 1.3rem;"></i>
                    <span class="notification-dot" id="notifDot"></span>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="p-4 text-center" style="color:var(--text-muted)">Loading activity logs...</div>
                    </div>
                </button>

                <div class="u-avatar" style="width:32px; height:32px; font-size:0.85rem;" id="header-avatar">A</div>
            </div>
        </header>

        <!-- SIDEBAR (All visible to all employees) -->
        <aside id="sidebar">
            <div class="user-mini-profile">
                <div class="u-info">
                    <div class="u-avatar" id="side-avatar">A</div>
                    <div class="u-details">
                        <h4 id="side-name">Loading...</h4>
                        <p id="side-job">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="nav-scroll">
                <!-- OVERVIEW -->
                <div class="nav-item active" onclick="navigateTo('/')">
                    <i class="ri-dashboard-line"></i> <span class="nav-text">Overview</span>
                </div>
                
                <!-- OPERATIONS -->
                <div class="nav-section-title"><span class="nav-text">Operations</span></div>
                <div class="nav-item" onclick="navigateTo('/orders')">
                    <i class="ri-shopping-bag-3-line"></i> <span class="nav-text">Orders</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/clients')">
                    <i class="ri-user-line"></i> <span class="nav-text">Clients</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/requests')">
                    <i class="ri-database-2-line"></i> <span class="nav-text">Customer Requests</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/support')">
                    <i class="ri-customer-service-2-line"></i> <span class="nav-text">Support Tickets</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/vouchers')">
                    <i class="ri-ticket-2-line"></i> <span class="nav-text">Vouchers</span>
                </div>
                
                <!-- MANAGEMENT -->
                <div class="nav-section-title"><span class="nav-text">Management</span></div>
                <div class="nav-item" onclick="navigateTo('/portfolio')">
                    <i class="ri-gallery-line"></i> <span class="nav-text">Portfolio</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/content')">
                    <i class="ri-layout-masonry-line"></i> <span class="nav-text">Content & Pkg</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/public-promos')">
                    <i class="ri-coupon-3-line"></i> <span class="nav-text">Public Promos</span>
                </div>
                
                <!-- SYSTEM -->
                <div class="nav-section-title"><span class="nav-text">System</span></div>
                <div class="nav-item" onclick="navigateTo('/crew')">
                    <i class="ri-team-line"></i> <span class="nav-text">Internal Crew</span>
                </div>
                <div class="nav-item" onclick="navigateTo('/config')">
                    <i class="ri-settings-4-line"></i> <span class="nav-text">System Config</span>
                </div>

                <!-- APPROVALS (Admin Power) -->
                <div class="nav-item hidden" id="nav-approvals" onclick="navigateTo('/approvals')">
                    <i class="ri-shield-check-line" style="color: var(--warning)"></i> <span class="nav-text">Approval Tools</span>
                </div>
                
                <!-- FINANCE -->
                <div class="nav-section-title"><span class="nav-text">Finance</span></div>
                <div class="nav-item" onclick="navigateTo('/commissions')">
                    <i class="ri-money-dollar-circle-line"></i> <span class="nav-text">Commissions</span>
                </div>
                
                <!-- PERSONAL -->
                <div class="nav-section-title"><span class="nav-text">Personal</span></div>
                <div class="nav-item" onclick="navigateTo('/my-profile')">
                    <i class="ri-user-settings-line"></i> <span class="nav-text">My Profile</span>
                </div>
            </div>

            <div style="padding: 1.5rem; border-top: 1px solid var(--border);">
                <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="handleLogout()">
                    <i class="ri-logout-box-r-line"></i> <span>Logout</span>
                </button>
            </div>
        </aside>

        <main id="main"></main>
    </div>

    <!-- MAIN MODAL -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Title</div>
                <button class="btn-icon" onclick="closeModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- INVOICE MODAL -->
    <div class="modal-overlay" id="invoiceModalOverlay">
        <div class="invoice-modal-wrapper">
            <div class="invoice-controls">
                <button class="btn btn-primary" onclick="downloadCurrentInvoice()">
                    <i class="ri-file-download-line"></i> Download PDF
                </button>
                <button class="btn btn-danger-solid" onclick="closeInvoiceModal()" style="border-radius: 50%; width: 36px; height: 36px; padding: 0;">
                    <i class="ri-close-line" style="font-size: 1.1rem;"></i>
                </button>
            </div>
            <div class="invoice-paper" id="invoice-content"></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- JAVASCRIPT -->
    <script>
        // --- CONSTANTS & CONFIG ---
        
        // Updated Job Titles & Rates
        const JOB_TITLES = [
            "Founder & Managing Director", 
            "Project & Client Manager", 
            "Account / Operations / Marketing Manager", 
            "Finance / Billing Executive", 
            "People / Team Operations Executive", 
            "Business Development Executive", 
            "Sales Executive", 
            "Client Success Coordinator", 
            "Client Experience Executive", 
            "Technical Specialist", 
            "Web Developer", 
            "Full Stack Developer", 
            "Automation & AI Specialist", 
            "Support Operations Executive" 
        ];

        const DEFAULT_COMMISSION_RATES = {
            "Founder & Managing Director": 0.05,
            "Project & Client Manager": 0.04,
            "Account / Operations / Marketing Manager": 0.04,
            "Finance / Billing Executive": 0.0,
            "People / Team Operations Executive": 0.0,
            "Business Development Executive": 0.125,
            "Sales Executive": 0.125,
            "Client Success Coordinator": 0.025,
            "Client Experience Executive": 0.025,
            "Technical Specialist": 0.04,
            "Web Developer": 0.04,
            "Full Stack Developer": 0.05,
            "Automation & AI Specialist": 0.05,
            "Support Operations Executive": 0.025
        };

        // PERMISSION KEYS
        const PERMISSION_KEYS = {
            EDIT_ORDERS: 'edit_orders',
            EDIT_CLIENTS: 'edit_clients',
            DELETE_REQUESTS: 'delete_requests',
            DELETE_SUPPORT: 'delete_support',
            EDIT_VOUCHERS: 'edit_vouchers',
            EDIT_PORTFOLIO: 'edit_portfolio',
            EDIT_CONTENT: 'edit_content',
            EDIT_PROMOS: 'edit_promos',
            EDIT_CREW: 'edit_crew',
            EDIT_CONFIG: 'edit_config',
            VIEW_FINANCE: 'view_finance',
            EDIT_FINANCE: 'edit_finance', 
            APPROVE_ACTIONS: 'approve_actions' 
        };

        function getDefaultRate(title) {
            return DEFAULT_COMMISSION_RATES[title] || 0.0;
        }

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
            authDomain: "ddnetwork-database.firebaseapp.com",
            projectId: "ddnetwork-database",
            storageBucket: "ddnetwork-database.firebasestorage.app",
            messagingSenderId: "699127560990",
            appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
        };
        let db, auth, currentUser, userData = null;
        let currentOrderDataForPrint = null;
        
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth(); } catch(e) { console.log("Firebase init error", e); }

        // --- AUTO CREATE CONFIG ---
        async function initializeDatabase() {
            const configRef = db.collection("config").doc("site_settings");
            const doc = await configRef.get();
            if (!doc.exists) {
                console.log("Config not found, creating default...");
                await configRef.set({
                    maintenance_active: false,
                    maintenance_message: "We are currently performing scheduled maintenance.",
                    prices: { html: 199, frontend:599 },
                    packageDetails: {
                        frontend: ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"],
                        ai: ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"]
                    },
                    discountActive: false,
                    discountPercent: 0.1
                });
                showToast("Database initialized!", "success");
            }
            const pmSnapshot = await db.collection("payment_methods").limit(1).get();
            if (pmSnapshot.empty) {
                const defaults = [
                    { id: 'tng', name: 'TNG eWallet', link: 'https://payment.tngdigital.com.my/sc/bDLob7YcpG', active: true },
                    { id: 'fpx', name: 'Online Banking (FPX)', link: 'https://toyyibpay.com', active: true }
                ];
                defaults.forEach(pm => db.collection("payment_methods").add(pm));
            }
        }

        function logActivity(msg) {
            if(!currentUser) return; 
            db.collection("activity_logs").add({
                message: msg,
                actor: userData.email,
                actorName: userData.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => console.error("Log error:", e));
        }

        function formatDateTime(timestamp) {
            if(!timestamp) return '-';
            const d = timestamp instanceof Date ? timestamp : timestamp.toDate();
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function generateDocIdFromName(name) {
            if(!name) return 'new-project';
            return name.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, ''); 
        }

        function updateDocIdPreview() {
            const nameVal = document.getElementById('p-name').value;
            const idVal = generateDocIdFromName(nameVal);
            const idInput = document.getElementById('p-doc-id');
            if(idInput) idInput.value = idVal;
        }

        async function getNextId(type) {
            if(type === 'crew') {
                 try {
                     const snap = await db.collection("users").where("crewId", "!=", null).get();
                     let existingIds = [];
                     snap.forEach(doc => { const id = doc.data().crewId; if(id) existingIds.push(parseInt(id)); });
                     existingIds.sort((a,b) => a-b);
                     let nextId = 1;
                     if(existingIds.length > 0) { for(let i=0; i<existingIds.length; i++) { if(existingIds[i] === nextId) nextId++; else break; } }
                     return String(nextId).padStart(3, '0');
                 } catch(e) { return "001"; }
            } else if (type === 'ticket') {
                try {
                    const snap = await db.collection("tickets").orderBy("ticketId", "desc").limit(1).get();
                    let nextNum = 1;
                    if (!snap.empty) {
                        const lastId = snap.docs[0].data().ticketId; 
                        const parts = lastId.split('-');
                        if (parts.length >1) {
                            const lastNum = parseInt(parts[1], 10);
                            if (!isNaN(lastNum)) nextNum = lastNum + 1;
                        }
                    }
                    const paddedNum = String(nextNum).padStart(4, '0');
                    return `#Ticket-${paddedNum}`;
                } catch (e) {
                    console.error("Error generating ticket ID", e);
                    return "#Ticket-0001";
                }
            }
            return null;
        }

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('loginInput').value.trim();
            const pass = document.getElementById('loginPass').value;
            const isCrewId = /^\d{3,}$/.test(input);
            let emailToUse = input;
            if (isCrewId) {
                const snap = await db.collection("users").where("crewId", "==", input).get();
                if (snap.empty) return showToast("Crew ID not found.", "error");
                emailToUse = snap.docs[0].data().email;
            }
            auth.signInWithEmailAndPassword(emailToUse, pass).catch(err => showToast(err.message, "error"));
        });

        // AUTH STATE LISTENER
        auth.onAuthStateChanged((user) => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        currentUser = user;
                        userData = doc.data();
                        
                        // Ensure permissions object exists
                        if(!userData.permissions) userData.permissions = {};

                        // UI Update
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        
                        document.getElementById('side-name').innerText = userData.name || 'User';
                        document.getElementById('side-job').innerText = userData.jobTitle || userData.role;
                        document.getElementById('side-avatar').innerText = (userData.name || 'A').charAt(0).toUpperCase();
                        document.getElementById('header-avatar').innerText = (userData.name || 'A').charAt(0).toUpperCase();

                        // Show Approval Tab if user has Admin Power
                        if(hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) {
                            document.getElementById('nav-approvals').classList.remove('hidden');
                        } else {
                            document.getElementById('nav-approvals').classList.add('hidden');
                        }

                        // Notifications restricted to Admins
                        if(userData.role === 'crew') {
                            document.getElementById('notif-btn').style.display = 'none';
                        } else {
                            document.getElementById('notif-btn').style.display = 'flex'; 
                            listenForNotifications(); 
                        }

                        initRouter();
                        initializeDatabase(); 
                    } else {
                        showToast("Access Denied. User record not found.", "error");
                        auth.signOut();
                    }
                });
            } else {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        function handleLogout() { auth.signOut().then(() => location.reload()); }

        // --- NOTIFICATIONS ---
        function toggleNotifications() {
            const el = document.getElementById('notifDropdown');
            el.classList.toggle('show');
        }
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('notifDropdown');
            const btn = document.getElementById('notif-btn');
            if (!dd.contains(e.target) && !btn.contains(e.target)) {
                dd.classList.remove('show');
            }
        });

        function listenForNotifications() {
            db.collection("activity_logs").orderBy("timestamp", "desc").limit(10).onSnapshot(snap => {
                const container = document.getElementById('notifDropdown');
                if(snap.empty) {
                    container.innerHTML = '<div class="p-4 text-center" style="color:var(--text-muted)">No recent activity</div>';
                    document.getElementById('notifDot').style.display = 'none';
                    return;
                }
                document.getElementById('notifDot').style.display = 'block';
                container.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="notif-item">
                        <strong>${d.actorName || d.actor}</strong>
                        <div>${d.message}</div>
                        <span class="notif-time">${formatDateTime(d.timestamp)}</span>
                    </div>`;
                }).join('');
            });
        }

        // --- ACCESS CONTROL & PERMISSIONS ---
        
        function isSuperAdmin() { return userData && userData.role === 'super_admin'; }
        function isFounder() { return userData && userData.jobTitle && userData.jobTitle.includes("Founder"); }
        
        function hasPermission(key) {
            if(!userData) return false;
            if(isSuperAdmin() || isFounder()) return true;
            return userData.permissions && userData.permissions[key] === true;
        }

        // --- APPROVAL WORKFLOW CORE ---
        
        // Check if User has "Auto-Approve" permissions (Approve Actions)
        function canAutoApprove() {
            return hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS);
        }

        // Generic function to save data either directly or to pending
        async function saveDataWithApproval(collection, docId, newData, originalData, contextMsg) {
            const isAutoApprover = canAutoApprove();

            if (isAutoApprover) {
                // Direct Save
                try {
                    await db.collection(collection).doc(docId).update(newData);
                    showToast("Changes saved successfully", "success");
                    logActivity(`${contextMsg} (Direct Save)`);
                    return true;
                } catch(e) {
                    showToast("Error saving: " + e.message, "error");
                    return false;
                }
            } else {
                // Pending Workflow
                try {
                    // Check for existing pending edit for this doc
                    const existingSnap = await db.collection("pending_edits")
                        .where("targetCollection", "==", collection)
                        .where("targetDocId", "==", docId)
                        .where("status", "==", "Pending")
                        .get();
                    
                    if (!existingSnap.empty) {
                        return showToast("A request for this item is already pending approval.", "warning");
                    }

                    await db.collection("pending_edits").add({
                        targetCollection: collection,
                        targetDocId: docId,
                        originalData: originalData,
                        newData: newData,
                        requesterId: currentUser.uid,
                        requesterName: userData.name,
                        requesterEmail: userData.email,
                        context: contextMsg,
                        status: 'Pending',
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Request sent for approval.", "warning");
                    logActivity(`Requested approval for: ${contextMsg}`);
                    closeModal();
                    return true;
                } catch(e) {
                    showToast("Error creating request: " + e.message, "error");
                    return false;
                }
            }
        }

        // --- ROUTING SYSTEM ---
        const routes = {
            '/': renderOverview,
            '/orders': renderOrders,
            '/clients': renderClients,
            '/crew': renderCrew,
            '/support': renderSupport,
            '/vouchers': renderVouchers,
            '/content': renderContent,
            '/config': renderConfig,
            '/portfolio': renderPortfolio,
            '/requests': renderRequests,
            '/my-profile': renderMyProfile,
            '/public-promos': renderPublicPromos,
            '/commissions': renderCommissions,
            '/approvals': renderApprovals
        };

        function navigateTo(path) {
            window.history.pushState({ path: path }, "", path);
            loadRoute(path);
        }

        function loadRoute(path) {
            const renderFn = routes[path];
            if (renderFn) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const activeItem = document.querySelector(`.nav-item[onclick="navigateTo('${path}')"]`);
                if(activeItem) activeItem.classList.add('active');
                
                renderFn();

                if(window.innerWidth <= 1024) {
                    document.getElementById('sidebar').classList.remove('mobile-open');
                    document.getElementById('sidebarOverlay').classList.remove('active');
                }
            }
        }

        function initRouter() {
            const path = window.location.pathname;
            const basePath = path.replace(/\/[^/]+\.html$/, '') || '/';
            if (routes[basePath]) {
                loadRoute(basePath);
            } else {
                navigateTo('/');
            }
        }

        window.onpopstate = (event) => {
            if (event.state && event.state.path) {
                loadRoute(event.state.path);
            }
        };

        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            if(window.innerWidth > 1024) {
                sb.classList.toggle('collapsed');
            } else {
                sb.classList.toggle('mobile-open');
                ov.classList.toggle('active');
            }
        }

        // --- UTILS ---
        function showModal(title, body, footer='') {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalFooter').innerHTML = footer;
            document.getElementById('modalOverlay').classList.add('open');
        }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
        function showToast(msg, type='info') {
            const t = document.createElement('div'); t.className = `toast ${type}`;
            const icon = type=='success'?'ri-checkbox-circle-fill':(type=='error'?'ri-error-warning-fill':(type=='warning'?'ri-alert-fill':'ri-information-fill'));
            t.innerHTML = `<i class="${icon}" style="font-size:1.2rem; color: ${type=='success'?'var(--success)':(type=='error'?'var(--danger)':(type=='warning'?'var(--warning)':'white'))}"></i> <span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(()=>t.classList.add('show'), 10);
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 400); }, 3500);
        }

        async function deleteUser(uid, name, type) {
            if(!isSuperAdmin()) return showToast("Access Denied", "error");
            if(!confirm(`Are you sure you want to PERMANENTLY DELETE ${name}? This action cannot be undone.`)) return;
            try {
                await db.collection("users").doc(uid).delete();
                logActivity(`Deleted user: ${name} (${type})`);
                showToast("User deleted successfully", "success");
            } catch (error) {
                console.error("Delete error:", error);
                showToast("Error deleting user: " + error.message, "error");
            }
        }

        // ---1. OVERVIEW ---
        function renderOverview() {
            const main = document.getElementById('main');
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4" style="flex-wrap: wrap; gap:10px;">
                    <h2 style="font-size:1.5rem; font-weight:700; letter-spacing:-0.5px;">Dashboard Overview</h2>
                    <button class="btn btn-secondary btn-sm" onclick="window.print()"><i class="ri-download-cloud-2-line"></i> Export Report</button>
                </div>
                <div class="stats-grid" id="stats-grid">
                    <div class="page-loader" style="height:100px;"><div class="loading-spinner"></div></div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="list-group">
                        <h3><i class="ri-pulse-line" style="color:var(--success)"></i> Quick Actions</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">
                            <button class="btn btn-secondary" onclick="navigateTo('/orders')"><i class="ri-shopping-bag-line"></i> New Order</button>
                            <button class="btn btn-secondary" onclick="navigateTo('/support')"><i class="ri-ticket-line"></i> Check Tickets</button>
                            <button class="btn btn-secondary" onclick="navigateTo('/requests')"><i class="ri-database-2-line"></i> Requests</button>
                            ${hasPermission(PERMISSION_KEYS.EDIT_CREW) ? `<button class="btn btn-secondary" onclick="navigateTo('/crew')"><i class="ri-user-add-line"></i> Add Crew</button>` : ''}
                        </div>
                    </div>
                    <div class="list-group">
                        <h3><i class="ri-history-line" style="color:var(--primary)"></i> Recent Activity</h3>
                        <div id="activity-feed"><div class="text-center p-4 text-muted">Loading...</div></div>
                    </div>
                </div>
            `;
            
            db.collection("activity_logs").orderBy("timestamp", "desc").limit(5).onSnapshot(snap => {
                const feed = document.getElementById('activity-feed');
                if(feed) {
                    if(snap.empty) feed.innerHTML = '<div class="text-muted text-sm text-center mt-2">No recent activity</div>';
                    else feed.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        return `<div class="activity-item">
                            <div class="activity-icon"><i class="ri-shield-flash-line" style="color:var(--primary)"></i></div>
                            <div class="activity-content">
                                <h5>${d.message}</h5>
                                <p>${d.actorName || d.actor}</p>
                            </div>
                            <div class="activity-time">${formatDateTime(d.timestamp)}</div>
                        </div>`;
                    }).join('');
                }
            });

            const promises = [
                db.collection("tickets").where("status", "in", ["Open", "In Progress"]).get(),
                db.collection("users").where("role", "==", "user").get(),
                db.collection("orders").where("status", "==", "Pending").get(),
                db.collection("orders").where("status", "==", "Paid").get(),
                db.collection("customer_requests").where("status", "==", "Pending").get()
            ];

            Promise.all(promises).then(([tSnap, uSnap, oSnapP, oSnapPaid, rSnapP]) => {
                const stats = [
                    { label: "Active Cases", val: tSnap.size, icon: "ri-customer-service-2-line", color: "var(--ticket)" },
                    { label: "Total Clients", val: uSnap.size, icon: "ri-user-smile-line", color: "var(--primary)" },
                    { label: "Pending Orders", val: oSnapP.size, icon: "ri-shopping-basket-2-line", color: "var(--text-muted)" },
                    { label: "Revenue (Est.)", val: `RM ${oSnapPaid.size * 300}`, icon: "ri-wallet-3-line", color: "var(--success)" }
                ];
                const grid = document.getElementById('stats-grid');
                if(grid) {
                    grid.innerHTML = stats.map(s => `
                        <div class="stat-card">
                            <div class="stat-icon" style="color:${s.color}; background:${s.color}15"><i class="${s.icon}"></i></div>
                            <div class="stat-info">
                                <div class="stat-val">${s.val}</div>
                                <div class="stat-label">${s.label}</div>
                            </div>
                        </div>
                    `).join('');
                }
            });
        }

        // --- 2. ORDERS ---
        function renderOrders() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_ORDERS);
            document.getElementById('main').innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3>Order Management</h3>
                        <div class="flex items-center gap-2">
                            ${!canAutoApprove() ? '<span class="req-approval-badge">Edit Requires Approval</span>' : ''}
                            <input type="text" id="orderSearch" placeholder="Search ID, Name, Domain..." style="width:250px;" onkeyup="filterTable('orders-tbody', this.value)">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Package</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                                <tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('orders-tbody');
                if(!tbody) return;
                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No orders found</td></tr>';
                    return;
                }

                tbody.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    const domainDisplay = d.domain ? `<span class="font-mono" style="color:var(--primary)">${d.domain}</span>` : `<span style="color:var(--text-faint)">N/A</span>`;
                    let voucherBadge = '<span style="color:var(--text-faint)">None</span>';
                    if (d.voucherCode) {
                        voucherBadge = `<span class="badge badge-voucher"><i class="ri-coupon-line"></i> ${d.voucherCode}</span>`;
                    }
                    let statusColor = '#71717a';
                    if(d.status === 'Completed') statusColor = 'var(--success)';
                    if(d.status === 'Paid') statusColor = 'var(--primary)';
                    if(d.status === 'Cancelled') statusColor = 'var(--danger)';
                    
                    return `<tr>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td><strong>${d.customerName}</strong></td>
                        <td>${d.package}</td>
                        <td>${d.total}</td>
                        <td><span class="badge" style="background:${statusColor}15; color:${statusColor}; border:1px solid ${statusColor}25">${d.status}</span></td>
                        <td>
                            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                                <button class="btn btn-sm btn-secondary" onclick="viewOrder('${doc.id}')">Manage</button>
                                <button class="btn btn-sm btn-info" title="Generate Invoice" onclick="generateInvoice('${doc.id}')"><i class="ri-file-list-2-line"></i> PDF</button>
                                <button class="btn btn-sm btn-success" title="Send WhatsApp Remainder" onclick="sendPaymentReminder('${doc.id}')"><i class="ri-whatsapp-line"></i> WA</button>
                                ${isSuperAdmin() ? `<button class="btn btn-sm btn-danger" onclick="deleteOrder('${doc.id}')"><i class="ri-delete-bin-line"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        function downloadCurrentInvoice() {
            if (!currentOrderDataForPrint) return showToast("No invoice loaded", "error");
            const originalTitle = document.title;
            const invoiceId = currentOrderDataForPrint.orderRef;
            document.title = `Invoice #${invoiceId} - DDNetwork One`;
            window.print();
            setTimeout(() => { document.title = originalTitle; }, 1000);
        }

        async function generateInvoice(orderId) {
            try {
                const orderDoc = await db.collection("orders").doc(orderId).get();
                if(!orderDoc.exists) return showToast("Order not found", "error");
                const d = orderDoc.data();
                currentOrderDataForPrint = { orderRef: orderId.substring(0,8).toUpperCase(), customerName: d.customerName, package: d.package, total: d.total };

                let paymentMethodsHTML = '<p>No payment methods configured in config.</p>';
                try {
                    const pmSnap = await db.collection("payment_methods").where("active", "==", true).limit(2).get();
                    if(!pmSnap.empty) {
                        paymentMethodsHTML = `<div class="inv-bank-grid">`;
                        pmSnap.forEach(pm => {
                            const data = pm.data();
                            paymentMethodsHTML += `
                                <div class="inv-bank-item">
                                    <strong>${data.name}</strong>
                                    <a href="${data.link}" target="_blank" style="color:var(--primary); text-decoration:none;">${data.name} Link &rarr;</a>
                                </div>`;
                        });
                        paymentMethodsHTML += `</div>`;
                    }
                } catch(e) { console.error("Error fetching payments", e); }

                const dateStr = formatDateTime(d.timestamp);
                const orderRef = orderId.substring(0,8).toUpperCase();
                const total = parseFloat(d.total.replace('RM ', '')).toFixed(2);

                const invoiceHTML = `
                    <div class="inv-header">
                        <div class="inv-logo-area">
                            <h1>INVOICE</h1>
                            <p><strong>DDNetwork One</strong><br>PG0572133-K</p>
                        </div>
                        <div class="inv-title-area">
                            <h2>#${orderRef}</h2>
                            <div class="inv-meta">
                                <div>Date Issued: <strong>${dateStr}</strong></div>
                                <div>Status: <strong style="color:${d.status==='Paid'?'#10b981':'#f59e0b'}">${d.status}</strong></div>
                            </div>
                        </div>
                    </div>
                    <div class="inv-grid">
                        <div>
                            <div class="inv-section-title">Bill To</div>
                            <div class="inv-box">
                                <h3>${d.customerName}</h3>
                                <p>${d.customerEmail}</p>
                                <p>${d.customerPhone || '-'}</p>
                                ${d.customerCompany ? `<p>${d.customerCompany}</p>` : ''}
                            </div>
                        </div>
                        <div>
                            <div class="inv-section-title">Pay To</div>
                            <div class="inv-box">
                                <h3>DDNetwork One</h3>
                                <p>Kedah, Malaysia</p>
                                <p><strong>Email:</strong> sales@ddnet.my</p>
                            </div>
                        </div>
                    </div>
                    <table class="inv-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Billing</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <strong>${d.package}</strong><br>
                                    <span style="color:#64748b; font-size:12px;">${d.domain ? `Domain: ${d.domain}` : 'Domain pending'}</span>
                                </td>
                                <td>
                                    <span style="font-size:13px; background:#f1f5f9; padding:2px 6px; border-radius:4px;">${d.billingCycle || 'One-Time'}</span>
                                </td>
                                <td>RM ${total}</td>
                            </tr>
                            ${d.voucherCode ? `<tr><td><strong>Discount</strong> <span style="color:#10b981; font-size:12px;">(${d.voucherCode})</span></td><td></td><td style="color:#10b981;">- RM 0.00</td></tr>` : ''}
                        </tbody>
                    </table>
                    <div class="inv-total-section">
                        <div class="inv-total-box">
                            <div class="inv-total-row"><span>Subtotal</span><span>RM ${total}</span></div>
                            <div class="inv-total-row"><span>Tax (0%)</span><span>RM 0.00</span></div>
                            <div class="inv-total-row final"><span>Total Due</span><span>RM ${total}</span></div>
                        </div>
                    </div>
                    <div class="inv-bank-details">
                        <div class="inv-bank-title"><i class="ri-bank-card-line" style="color:var(--primary)"></i> Payment Methods</div>
                        ${paymentMethodsHTML}
                        <p style="margin-top:10px; font-size:12px; color:#64748b;">Please include Invoice #${orderRef} in your payment reference.</p>
                    </div>
                    <div class="inv-footer">
                        <p>Thank you for your business!</p>
                        <p>Generated by DDNetwork Admin Portal</p>
                    </div>
                `;
                document.getElementById('invoice-content').innerHTML = invoiceHTML;
                document.getElementById('invoiceModalOverlay').classList.add('open');
            } catch (err) {
                console.error(err);
                showToast("Error generating invoice", "error");
            }
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModalOverlay').classList.remove('open');
            currentOrderDataForPrint = null;
        }

        async function sendPaymentReminder(id) {
            if(!hasPermission(PERMISSION_KEYS.EDIT_ORDERS)) return showToast("Access Denied", "error");

            try {
                const doc = await db.collection("orders").doc(id).get();
                if(!doc.exists) return;
                const d = doc.data();
                let payLink = "https://ddnet.my"; 
                try {
                    const pmSnap = await db.collection("payment_methods").where("active", "==", true).limit(1).get();
                    if(!pmSnap.empty) payLink = pmSnap.docs[0].data().link;
                } catch(e) {}
                const orderRef = id.substring(0,6).toUpperCase();

                let msg = "";
                if (d.status === "Pending" || d.status === "Cancelled" || !d.status) {
                    msg = `Hi ${d.customerName},
This is ${userData.name} from DDNetwork.

We noticed that your order #${orderRef} is incomplete. Kindly complete remaining details/payment so we can process your order promptly.

If you need any assistance, feel free to reply to this message.

Thank you for choosing DDNetwork.

 DDNetwork Team`;
                } else {
                    msg = ` Hi ${d.customerName},\n\nReminder regarding your order with DDNetwork One.\n\n *Invoice:* #${orderRef}\n *Package:* ${d.package}\n *Total:* ${d.total}\n\n *Payment Link:* ${payLink}\n\nThank you! `;
                }
                
                let cleanPhone = d.customerPhone ? d.customerPhone.replace(/^0/, '60') : '60123456789';
                if(!cleanPhone.startsWith('+')) cleanPhone = '+' + cleanPhone;
                window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
                showToast("Opening WhatsApp...", "success");
                logActivity(`Sent payment reminder for Order #${orderRef}`);
            } catch(err) {
                console.error(err);
                showToast("Error sending reminder", "error");
            }
        }

        async function viewOrder(id) {
            const doc = await db.collection("orders").doc(id).get();
            const d = doc.data();
            
            // Multi-select Sales Rep Logic
            let salesRepHTML = '<div class="multi-select-container">';
            const currentReps = d.salesRepIds || []; // Array of IDs
            
            try {
                const crewSnap = await db.collection("users").where("role", "in", ["super_admin", "admin", "crew"]).get();
                if(crewSnap.empty) {
                    salesRepHTML = '<div class="p-4 text-muted">No staff found</div>';
                } else {
                    crewSnap.forEach(c => {
                        const cData = c.data();
                        const isChecked = currentReps.includes(c.id) ? 'checked' : '';
                        salesRepHTML += `
                            <label class="checkbox-item">
                                <input type="checkbox" class="rep-checkbox" value="${c.id}" ${isChecked}>
                                <span>${cData.name} (${cData.jobTitle || cData.role})</span>
                            </label>`;
                    });
                }
            } catch(e) { console.error(e); }
            salesRepHTML += '</div>';

            const voucherDisplay = d.voucherCode ? `<div class="mb-4"><label>Voucher Used</label><input readonly value="${d.voucherCode}" style="color:var(--warning); border-color:var(--warning)"></div>` : '';
            
            const isAuto = canAutoApprove();
            const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;

            showModal(`Manage Order`, `
                ${voucherDisplay}
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label class="text-muted text-sm">Name</label><input id="o-name" value="${d.customerName}"></div>
                    <div><label class="text-muted text-sm">Email</label><input id="o-email" value="${d.customerEmail}"></div>
                    <div><label class="text-muted text-sm">Phone</label><input id="o-phone" value="${d.customerPhone||''}"></div>
                    <div><label class="text-muted text-sm">Total</label><input id="o-total" value="${d.total}"></div>
                </div>
                <div class="mb-4 p-2" style="background:rgba(59,130,246,0.05); border-radius:6px; border:1px solid rgba(59,130,246,0.1);">
                    <div class="flex justify-between items-center">
                        <span style="font-size:0.8rem; color:var(--text-muted);">Billing Cycle</span>
                        <span class="font-bold" style="color:var(--primary);">${d.billingCycle || '-'}</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label>Sales Representatives (Multiple)</label>
                    ${salesRepHTML}
                    <small class="text-muted">Select all employees entitled to commission for this order.</small>
                </div>
                <div class="mt-4">
                    <label>Client Domain</label>
                    <div style="display:flex; gap:10px;">
                         <span style="padding:0.6rem; background:var(--bg-input); border:1px solid var(--border); border-radius:6px 0 0 6px 0; color:var(--text-muted);">https://</span>
                         <input id="o-domain" value="${d.domain || ''}" placeholder="example.com" style="border-radius:0 6px 6px 0;">
                    </div>
                    <small class="text-muted">Leave empty if no domain yet.</small>
                </div>
                <label class="mt-4 mb-2 block">Update Status</label>
                <select id="upd-status">
                    <option value="Pending" ${d.status=='Pending'?'selected':''}>Pending</option>
                    <option value="Paid" ${d.status=='Paid'?'selected':''}>Paid</option>
                    <option value="Completed" ${d.status=='Completed'?'selected':''}>Completed</option>
                    <option value="Cancelled" ${d.status=='Cancelled'?'selected':''}>Cancelled</option>
                </select>
                ${footerNote}
            `, `<button class="btn btn-primary" onclick="updateOrderDetails('${id}')">Save Changes</button>`);
        }

        function updateOrderDetails(id) {
            if(!hasPermission(PERMISSION_KEYS.EDIT_ORDERS)) return showToast("Access Denied", "error");

            const updateData = {
                customerName: document.getElementById('o-name').value,
                customerEmail: document.getElementById('o-email').value,
                customerPhone: document.getElementById('o-phone').value,
                total: document.getElementById('o-total').value,
                domain: document.getElementById('o-domain').value.replace(/^https?:\/\//, ''), 
                status: document.getElementById('upd-status').value
            };
            
            // Handle Multi-select Reps
            const checkboxes = document.querySelectorAll('.rep-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            updateData.salesRepIds = selectedIds;
            // Clear old single fields if they exist
            updateData.salesRepId = firebase.firestore.FieldValue.delete();
            updateData.salesRepName = firebase.firestore.FieldValue.delete();

            // Fetch current data for comparison
            db.collection("orders").doc(id).get().then(doc => {
                const original = doc.data();
                saveDataWithApproval("orders", id, updateData, original, `Updated Order #${id.substr(0,6)}`);
            });
        }

        function deleteOrder(id) {
            if(!isSuperAdmin()) return;
            if(!confirm("Delete this order?")) return;
            db.collection("orders").doc(id).delete().then(() => {
                showToast("Order Deleted", "success");
                logActivity(`Deleted Order #${id.substr(0,6)}`);
            });
        }

        // --- 3. CLIENTS ---
        function renderClients() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_CLIENTS);
            document.getElementById('main').innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <h3>Client Directory</h3>
                        <div class="flex items-center gap-2">
                            ${!canAutoApprove() ? '<span class="req-approval-badge">Edit Requires Approval</span>' : ''}
                            <input type="text" id="clientSearch" placeholder="Search..." style="width:200px;" onkeyup="filterTable('client-tbody', this.value)">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Name</th><th>Company</th><th>Contact</th><th>Voucher</th><th>Actions</th></tr></thead><tbody id="client-tbody">
                        <tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr>
                        </tbody></table>
                    </div>
                </div>`;
            db.collection("users").where("role", "==", "user").onSnapshot(snap => {
                const tbody = document.getElementById('client-tbody');
                if(!tbody) return;
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No clients found</td></tr>'; return; }
                tbody.innerHTML = snap.docs.map(doc => {
                    const u = doc.data();
                    const vStatus = u.personalVoucher ? u.personalVoucher.status : 'None';
                    const vCode = u.personalVoucher ? u.personalVoucher.code : '-';
                    
                    let buttons = `
                        ${canEdit ? `<button class="btn btn-sm btn-secondary" onclick="editClient('${doc.id}')">Edit</button>` : ''}
                        ${canEdit ? `<button class="btn btn-sm btn-secondary" onclick="resetPassword('${u.email}')">Reset PW</button>` : ''}
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="openAssignVoucherModal('${doc.id}', '${u.name}')">Assign Voucher</button>` : ''}
                        ${isSuperAdmin() ? `<button class="btn btn-sm btn-danger" onclick="deleteUser('${doc.id}', '${u.name}', 'Client')"><i class="ri-delete-bin-line"></i></button>` : ''}
                    `;

                    return `<tr>
                        <td>${u.name}</td>
                        <td>${u.company||'-'}</td>
                        <td>${u.email}<br><small style="color:var(--text-faint)">${u.phone||''}</small></td>
                        <td>${vStatus !== 'None' ? `<span class="badge" style="background:${vStatus==='active'?'var(--success)':'var(--text-faint)'}">${vCode}</span>` : '-'}</td>
                        <td>
                            <div style="display:flex; gap:5px;">${buttons}</div>
                        </td>
                    </tr>`;
                }).join('');
            });
        }
        function editClient(uid) {
            db.collection("users").doc(uid).get().then(doc => {
                const u = doc.data();
                const isAuto = canAutoApprove();
                const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;
                
                showModal("Edit Client", `
                    <label>Name</label><input id="e-name" class="mb-4" value="${u.name}">
                    <label>Email</label><input readonly id="e-email" class="mb-4" value="${u.email}">
                    <label>Phone</label><input id="e-phone" class="mb-4" value="${u.phone||''}">
                    <label>Company</label><input id="e-comp" class="mb-4" value="${u.company||''}">
                    ${footerNote}
                `, `<button class="btn btn-primary" onclick="saveClient('${uid}')">Update</button>`);
            });
        }
        function saveClient(uid) {
            if(!hasPermission(PERMISSION_KEYS.EDIT_CLIENTS)) return showToast("Access Denied", "error");

            const updateData = {
                name: document.getElementById('e-name').value,
                phone: document.getElementById('e-phone').value,
                company: document.getElementById('e-comp').value
            };

            db.collection("users").doc(uid).get().then(doc => {
                const original = doc.data();
                saveDataWithApproval("users", uid, updateData, original, `Updated Client ${original.name}`);
            });
        }
        function resetPassword(email) {
            // Reset password is usually instant action or needs special approval. 
            // For now, let's keep it instant as it's helpful ops.
            if(!hasPermission(PERMISSION_KEYS.EDIT_CLIENTS)) return;
            if(confirm(`Send reset email to ${email}?`)) { auth.sendPasswordResetEmail(email).then(() => showToast("Reset email sent", "success")); }
        }

        // --- 4. CREW MANAGEMENT ---
        function renderCrew() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_CREW);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Internal Crew</h2>
                    ${canEdit && isSuperAdmin() ? `<button class="btn btn-primary" onclick="openAddCrewModal()"><i class="ri-add-line"></i> Add Crew</button>` : ''}
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>Crew ID</th><th>Name</th><th>Email</th><th>Role</th><th>Job Title</th><th>Comm. Rate</th><th>Actions</th></tr></thead><tbody id="crew-tbody">
                        <tr><td colspan="7" class="text-center"><div class="loading-spinner"></div></td></tr>
                        </tbody></table>
                    </div>
                </div>`;
            db.collection("users").where("role", "in", ["super_admin", "admin", "crew"]).onSnapshot(snap => {
                const tbody = document.getElementById('crew-tbody');
                if(!tbody) return;
                tbody.innerHTML = snap.docs.map(doc => {
                    const u = doc.data();
                    const rate = u.commissionRate ? (u.commissionRate * 100).toFixed(1) + '%' : '0%';
                    let buttons = '';
                    if (canEdit) {
                        buttons = `<button class="btn btn-sm btn-secondary" onclick="editCrew('${doc.id}')"><i class="ri-pencil-line"></i></button>`;
                        if (isSuperAdmin()) {
                            buttons += `<button class="btn btn-sm btn-danger" onclick="deleteUser('${doc.id}', '${u.name}', 'Crew')"><i class="ri-delete-bin-line"></i></button>`;
                        }
                    }
                    return `<tr>
                        <td class="font-mono" style="color:var(--primary)">${u.crewId || 'N/A'}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge badge-${u.role==='super_admin'?'admin':(u.role==='admin'?'admin':'crew')}">${u.role}</span></td>
                        <td>${u.jobTitle||'-'}</td>
                        <td><span class="badge" style="background:var(--success)15; color:var(--success)">${rate}</span></td>
                        <td>${buttons}</td>
                    </tr>`;
                }).join('');
            });
        }
        
        async function openAddCrewModal() {
            const newCrewId = await getNextId('crew');
            const jobOptions = JOB_TITLES.map(j => `<option value="${j}">${j}</option>`).join('');
            
            showModal("Add New Crew", `
                <div class="mb-4"><label>Crew ID</label><input id="c-id" value="${newCrewId}" readonly></div>
                <div class="mb-4"><label>Full Name</label><input id="c-name"></div>
                <div class="mb-4"><label>Email Address</label><input type="email" id="c-email"></div>
                <div class="mb-4">
                    <label>Job Title (Auto-Sets Role)</label>
                    <select id="c-job" onchange="autoSetRoleAndRate()">
                        <option value="">Select Job Title...</option>
                        ${jobOptions}
                    </select>
                </div>
                <div class="flex gap-4 mb-4">
                    <div style="flex:1">
                        <label>Role</label>
                        <input type="text" id="c-role" readonly style="background:var(--bg-sidebar)">
                    </div>
                    <div style="flex:1">
                        <label>Comm. Rate (%)</label>
                        <input type="number" step="0.1" id="c-rate" readonly style="background:var(--bg-sidebar)">
                    </div>
                </div>
                <div class="mb-4"><label>Temporary Password</label><input type="password" id="c-pass" placeholder="Set password"></div>
            `, `<button class="btn btn-primary" onclick="saveCrew('${newCrewId}')">Create Crew</button>`);
        }

        function autoSetRoleAndRate() {
            const title = document.getElementById('c-job').value;
            const roleInput = document.getElementById('c-role');
            const rateInput = document.getElementById('c-rate');
            
            // Auto Role Mapping
            let dbRole = 'crew'; 
            if(title === "Founder & Managing Director") dbRole = 'super_admin';
            else if (["Project & Client Manager", "Account / Operations / Marketing Manager", "Finance / Billing Executive", "People / Team Operations Executive"].includes(title)) dbRole = 'admin';

            roleInput.value = dbRole.toUpperCase();

            // Auto Rate
            const defaultRate = getDefaultRate(title);
            rateInput.value = (defaultRate * 100).toFixed(1);
        }

        async function saveCrew(newId) {
            const name = document.getElementById('c-name').value;
            const email = document.getElementById('c-email').value;
            const pass = document.getElementById('c-pass').value;
            const job = document.getElementById('c-job').value;
            const rateVal = parseFloat(document.getElementById('c-rate').value);

            if(!name || !email || !pass || !job) return showToast("Please fill all fields", "error");

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                
                // Determine DB Role
                let dbRole = 'crew';
                if(job === "Founder & Managing Director") dbRole = 'super_admin';
                else if (["Project & Client Manager", "Account / Operations / Marketing Manager", "Finance / Billing Executive", "People / Team Operations Executive"].includes(job)) dbRole = 'admin';

                // Create Permissions Object (Empty for new users, filled by Founder later)
                const initialPerms = {};

                await db.collection("users").doc(userCredential.user.uid).set({
                    crewId: newId,
                    name: name,
                    email: email,
                    role: dbRole,
                    jobTitle: job,
                    commissionRate: isNaN(rateVal) ? 0.0 : (rateVal / 100),
                    permissions: initialPerms,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal();
                showToast("Crew created successfully", "success");
                logActivity(`Created new crew member: ${name} (${newId})`);
            } catch(e) {
                showToast(e.message, "error");
            }
        }

        function editCrew(uid) {
            db.collection("users").doc(uid).get().then(doc => {
                const u = doc.data();
                const jobOptions = JOB_TITLES.map(j => `<option value="${j}" ${u.jobTitle===j?'selected':''}>${j}</option>`).join('');
                
                // Generate Permission Toggles
                let permsHTML = '<div style="margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem;"><label style="margin-bottom:0.5rem; display:block;">Access Permissions</label><div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">';
                const userPerms = u.permissions || {};
                
                for (const [key, label] of Object.entries({
                    [PERMISSION_KEYS.EDIT_ORDERS]: 'Edit Orders',
                    [PERMISSION_KEYS.EDIT_CLIENTS]: 'Edit Clients',
                    [PERMISSION_KEYS.DELETE_REQUESTS]: 'Delete Requests',
                    [PERMISSION_KEYS.DELETE_SUPPORT]: 'Delete Tickets',
                    [PERMISSION_KEYS.EDIT_VOUCHERS]: 'Edit Vouchers',
                    [PERMISSION_KEYS.EDIT_PORTFOLIO]: 'Edit Portfolio',
                    [PERMISSION_KEYS.EDIT_CONTENT]: 'Edit Content',
                    [PERMISSION_KEYS.EDIT_PROMOS]: 'Edit Promos',
                    [PERMISSION_KEYS.EDIT_CONFIG]: 'Edit Config'
                })) {
                    const isChecked = userPerms[key] ? 'checked' : '';
                    permsHTML += `
                    <label class="flex items-center gap-2" style="font-size:0.8rem; font-weight:400; color:var(--text-muted); text-transform:none;">
                        <input type="checkbox" class="perm-toggle" value="${key}" ${isChecked} style="width:auto; margin:0;"> ${label}
                    </label>`;
                }
                permsHTML += '</div></div>';

                // If Founder/SuperAdmin, show "Approve Actions" toggle too
                if(isFounder() || isSuperAdmin()) {
                    permsHTML += `<label class="flex items-center gap-2 mt-2" style="font-size:0.8rem; font-weight:400; color:var(--text-muted); text-transform:none;">
                        <input type="checkbox" class="perm-toggle" value="${PERMISSION_KEYS.APPROVE_ACTIONS}" ${userPerms[PERMISSION_KEYS.APPROVE_ACTIONS]?'checked':''} style="width:auto; margin:0;"> Approve Actions (Admin Power)
                    </label>`;
                }

                const isAuto = canAutoApprove();
                const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;

                showModal("Edit Crew Member", `
                    <div class="mb-4"><label>Crew ID</label><input id="e-c-id" value="${u.crewId}"></div>
                    <div class="mb-4"><label>Full Name</label><input id="e-c-name" value="${u.name}"></div>
                    <div class="mb-4"><label>Job Title</label><select id="e-c-job">${jobOptions}</select></div>
                    <div class="mb-4"><label>Role</label><select id="e-c-role">
                        <option value="crew" ${u.role==='crew'?'selected':''}>Internal Crew</option>
                        <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                        <option value="super_admin" ${u.role==='super_admin'?'selected':''}>Super Admin</option>
                    </select></div>
                     <div class="mb-4"><label>Commission Rate (%)</label><input type="number" step="0.1" id="e-c-rate" value="${(u.commissionRate*100).toFixed(1)}"></div>
                     ${permsHTML}
                     ${footerNote}
                `, `<button class="btn btn-primary" onclick="updateCrewData('${uid}')">Save</button>`);
            });
        }

        function updateCrewData(uid) {
            if(!hasPermission(PERMISSION_KEYS.EDIT_CREW)) return showToast("Access Denied", "error");
            const rateVal = parseFloat(document.getElementById('e-c-rate').value);
            
            // Gather Permissions
            const newPerms = {};
            document.querySelectorAll('.perm-toggle:checked').forEach(cb => {
                newPerms[cb.value] = true;
            });

            const updateData = {
                crewId: document.getElementById('e-c-id').value,
                name: document.getElementById('e-c-name').value,
                jobTitle: document.getElementById('e-c-job').value,
                role: document.getElementById('e-c-role').value,
                commissionRate: isNaN(rateVal) ? 0.0 : (rateVal / 100),
                permissions: newPerms
            };

            db.collection("users").doc(uid).get().then(doc => {
                const original = doc.data();
                saveDataWithApproval("users", uid, updateData, original, `Updated Crew ${updateData.name}`);
            });
        }

        // --- 5. SUPPORT ---
        function renderSupport() {
            const canDelete = hasPermission(PERMISSION_KEYS.DELETE_SUPPORT);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button class="btn btn-secondary" onclick="openCreateTicket()"><i class="ri-add-line"></i> Create New Ticket</button>
                    <input type="text" id="ticketSearch" placeholder="Search ID, Client..." style="width:200px;" onkeyup="filterTable('supp-tbody', this.value)">
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>ID</th><th>Date</th><th>Client</th><th>Issue</th><th>Assigned To</th><th>Status</th><th>Action</th></tr></thead><tbody id="supp-tbody">
                        <tr><td colspan="7" class="text-center"><div class="loading-spinner"></div></td></tr>
                        </tbody></table>
                    </div>
                </div>`;
            db.collection("tickets").orderBy("timestamp", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('supp-tbody');
                if(!tbody) return;
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No tickets found</td></tr>'; return; }
                tbody.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    let statusBadge = '';
                    if(d.status === 'Closed') statusBadge = 'var(--text-faint)';
                    else if(d.status === 'In Progress') statusBadge = 'var(--primary)';
                    else statusBadge = 'var(--warning)';
                    return `<tr>
                        <td class="font-mono" style="color:var(--ticket)">${d.ticketId || doc.id}</td>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td>${d.name}</td><td>${d.type}</td>
                        <td>${d.assignedToName || 'Unassigned'}</td>
                        <td><span class="badge" style="background:${statusBadge}15; color:${statusBadge}">${d.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewTicket('${doc.id}')">Manage</button>
                            ${canDelete ? `<button class="btn btn-sm btn-danger" onclick="deleteItem('ticket','${doc.id}')"><i class="ri-delete-bin-line"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        async function openCreateTicket() {
            const newId = await getNextId('ticket');
            showModal("Create Support Ticket", `
                <div class="mb-4"><label>Generated ID</label><input value="${newId}" readonly class="font-mono" style="color:var(--ticket)"></div>
                <div class="mb-4"><label>Client Name</label><input id="tk-name"></div>
                <div class="mb-4"><label>Issue Type</label><select id="tk-type"><option>Technical</option><option>Billing</option><option>Other</option></select></div>
                <div class="mb-4"><label>Details</label><textarea id="tk-msg"></textarea></div>
            `, `<button class="btn btn-primary" onclick="saveNewTicket('${newId}')">Create</button>`);
        }

        function saveNewTicket(id) {
            db.collection("tickets").add({ ticketId: id, name: document.getElementById('tk-name').value, type: document.getElementById('tk-type').value, message: document.getElementById('tk-msg').value, status: 'Open', timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { closeModal(); showToast("Ticket Created Successfully", "success"); logActivity(`Created new support ticket ${id}`); });
        }

        function viewTicket(id) {
            db.collection("tickets").doc(id).get().then(doc => {
                const d = doc.data();
                db.collection("users").where("role", "in", ["super_admin", "admin", "crew"]).get().then(snap => {
                    const crewOpts = snap.docs.map(c => `<option value="${c.id}" ${d.assignedTo===c.id?'selected':''}>${c.data().name}</option>`).join('');
                    const isAuto = canAutoApprove();
                    const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;

                    showModal(`Ticket: ${d.ticketId || id}`, `
                        <p class="mb-4 p-4" style="background:var(--bg-sidebar); border-radius:8px; border:1px solid var(--border)">${d.message}</p>
                        <div class="flex gap-4 mb-4">
                            <div style="flex:1"><label>Status</label><select id="tk-status"><option value="Open" ${d.status=='Open'?'selected':''}>Open</option><option value="In Progress" ${d.status=='In Progress'?'selected':''}>In Progress</option><option value="Closed" ${d.status=='Closed'?'selected':''}>Closed</option></select></div>
                            <div style="flex:1"><label>Assign To Crew</label><select id="tk-assign"><option value="">Unassigned</option>${crewOpts}</select></div>
                        </div>
                        ${footerNote}
                    `, `<button class="btn btn-primary" onclick="saveTicketDetails('${id}')">Save Changes</button>`);
                });
            });
        }
        function saveTicketDetails(id) {
            const newStatus = document.getElementById('tk-status').value;
            const newAssignId = document.getElementById('tk-assign').value;
            const newAssignName = newAssignId ? document.getElementById('tk-assign').options[document.getElementById('tk-assign').selectedIndex].text : "";
            
            const updateData = {
                status: newStatus, 
                assignedTo: newAssignId || null, 
                assignedToName: newAssignName
            };

            db.collection("tickets").doc(id).get().then(doc => {
                const original = doc.data();
                saveDataWithApproval("tickets", id, updateData, original, `Updated Ticket #${id}`);
            });
        }

        // --- 6. VOUCHERS ---
        let currentVoucherFilter = 'All'; 

        async function renderVouchers() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_VOUCHERS);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 style="font-size:1.25rem; font-weight:700;">Voucher Management</h3>
                    <div class="flex gap-2">
                        ${canEdit ? `<button class="btn btn-primary" onclick="openAssignVoucherModal(null, null)"><i class="ri-add-line"></i> Assign New</button>` : ''}
                        <button class="btn btn-secondary" onclick="renderVouchers()"><i class="ri-refresh-line"></i> Sync Data</button>
                    </div>
                </div>
                <div class="table-container" style="min-height: 200px; display:flex; justify-content:center; align-items:center;"><div id="voucher-loader" class="loading-spinner"></div></div>
                <div class="table-container hidden" id="active-vouchers-container"><div class="table-header"><h3>Active Vouchers</h3></div><div class="table-responsive"><table><thead><tr><th>User</th><th>Code</th><th>Status</th><th>Value</th><th>Expiry</th><th>Actions</th></tr></thead><tbody id="vouch-active"></tbody></table></div></div>
                <div class="table-container hidden" id="history-vouchers-container"><div class="table-header"><div class="flex items-center gap-4"><h3>Voucher History</h3><div class="filter-group"><select id="voucher-filter" class="filter-select" onchange="updateHistoryFilter(this.value)"><option value="All">Show All</option><option value="Redeemed">Redeemed Only</option><option value="Expired">Expired Only</option><option value="Disabled">Disabled Only</option></select></div></div></div><div class="table-responsive"><table><thead><tr><th>Code</th><th>User</th><th>Status</th><th>Date Moved</th><th>Actions</th></tr></thead><tbody id="vouch-history"></tbody></table></div></div>
            `;
            await syncVoucherLogic();
            document.getElementById('voucher-loader').parentElement.classList.add('hidden');
            document.getElementById('active-vouchers-container').classList.remove('hidden');
            document.getElementById('history-vouchers-container').classList.remove('hidden');

            db.collection("users").where("personalVoucher", "!=", null).onSnapshot(snap => {
                const tbody = document.getElementById('vouch-active');
                if(!tbody) return;
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const u = doc.data();
                    const v = u.personalVoucher;
                    const vStatus = v.status ? v.status : 'Active';
                    let statusColor = 'var(--success)';
                    const statusLower = vStatus.toLowerCase();
                    if (statusLower === 'suspended') statusColor = 'var(--danger)';
                    
                    let actions = `<button class="btn btn-sm btn-secondary" onclick="editVoucher('${doc.id}', '${v.code}')">Edit</button>`;
                    if (canEdit) {
                        actions += `<button class="btn btn-sm btn-success" onclick="markRedeem('${doc.id}', '${v.code}')"><i class="ri-check-double-line"></i> Redeem</button>`;
                        actions += `<button class="btn btn-sm btn-danger" onclick="disableVoucher('${doc.id}', '${v.code}')"><i class="ri-delete-bin-line"></i> Disable</button>`;
                    }

                    tbody.innerHTML += `<tr>
                        <td>${u.name}</td>
                        <td class="font-mono" style="color:var(--primary)">${v.code}</td>
                        <td><span class="badge" style="background:${statusColor}15; color:${statusColor}; border:1px solid ${statusColor}25">${vStatus}</span></td>
                        <td>${v.type=='fixed'?'RM '+v.value:v.value*100+'%'}</td>
                        <td>${v.expiryDate ? new Date(v.expiryDate.seconds*1000).toLocaleDateString() : '-'}</td>
                        <td>${actions}</td>
                    </tr>`;
                });
            });
            const updateHistoryListener = (filterVal) => {
                db.collection("vouchers_history").orderBy("movedAt", "desc").limit(50).onSnapshot(snap => {
                    const tbody = document.getElementById('vouch-history');
                    if(!tbody) return;
                    tbody.innerHTML = '';
                    snap.forEach(doc => {
                        const v = doc.data();
                        if(filterVal !== 'All' && v.status !== filterVal) return;
                        let actionBtn = v.status === 'Redeemed' ? `<small style="color:var(--text-faint)">Locked</small>` : (canEdit ? `<button class="btn btn-sm btn-success" onclick="restoreVoucher('${v.code}', '${v.ownerUid}')">Restore</button>` : '');
                        let statusColor = 'var(--text-faint)';
                        if (v.status === 'Redeemed') statusColor = 'var(--success)';
                        if (v.status === 'Expired') statusColor = 'var(--warning)'; 
                        if (v.status === 'Disabled') statusColor = 'var(--text-faint)';
                        tbody.innerHTML += `<tr><td class="font-mono">${v.code}</td><td>${v.assignedToName || '-'}</td><td><span class="badge" style="background:${statusColor}15; color:${statusColor}">${v.status}</span></td><td>${v.movedAt ? formatDateTime(v.movedAt) : '-'}</td><td>${actionBtn}</td></tr>`;
                    });
                });
            };
            updateHistoryListener(currentVoucherFilter);
        }
        window.updateHistoryFilter = (val) => { currentVoucherFilter = val; };
        async function syncVoucherLogic() {
            const usersSnap = await db.collection("users").where("personalVoucher", "!=", null).get();
            if(usersSnap.empty) return;
            let movedCount = 0;
            for (const userDoc of usersSnap.docs) {
                const uid = userDoc.id;
                const uData = userDoc.data();
                const vouch = uData.personalVoucher;
                const code = vouch.code;
                let moveToHistory = false;
                let statusReason = "";
                if(vouch.expiryDate) {
                    const expDate = vouch.expiryDate.toDate ? vouch.expiryDate.toDate() : new Date(vouch.expiryDate);
                    if(new Date() > expDate) { moveToHistory = true; statusReason = "Expired"; }
                }
                const currentStatus = (vouch.status || '').toLowerCase();
                if (currentStatus === 'redeemed' && !moveToHistory) { moveToHistory = true; statusReason = "Redeemed"; } else if (currentStatus === 'disabled' && !moveToHistory) { moveToHistory = true; statusReason = "Disabled"; }
                if(moveToHistory) {
                    await db.collection("vouchers_history").doc(code).set({ ...vouch, ownerUid: uid, assignedToName: uData.name, status: statusReason, movedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
                    console.log(`Moved ${code} to history as ${statusReason}`);
                    movedCount++;
                }
            }
            if(movedCount > 0) showToast(`Synced ${movedCount} vouchers to history`, "success");
        }
        function editVoucher(uid, code) {
            db.collection("users").doc(uid).get().then(doc => {
                const v = doc.data().personalVoucher;
                const exp = v.expiryDate ? new Date(v.expiryDate.seconds*1000).toISOString().split('T')[0] : '';
                const currentStatus = v.status ? v.status : 'Active';
                
                const isAuto = canAutoApprove();
                const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;

                showModal(`Edit Voucher ${code}`, `
                    <label>Code</label><input id="e-v-code" value="${v.code}" class="mb-4">
                    <label>Status</label><select id="e-v-status" class="mb-4"><option value="Active" ${currentStatus==='Active'?'selected':''}>Active</option><option value="Suspended" ${currentStatus==='Suspended'?'selected':''}>Suspended</option></select>
                    <label>Value</label><input type="number" id="e-v-val" value="${v.value}" class="mb-4">
                    <label>Expiry Date</label><input type="date" id="e-v-exp" value="${exp}" class="mb-4">
                    ${footerNote}
                `, `<button class="btn btn-primary" onclick="saveEditVoucher('${uid}')">Save</button>`);
            });
        }
        function saveEditVoucher(uid) {
            const newCode = document.getElementById('e-v-code').value.toUpperCase();
            const newStatus = document.getElementById('e-v-status').value;            
            db.collection("users").doc(uid).get().then(doc => {
                const v = doc.data().personalVoucher;
                const newVouch = { ...v, code: newCode, value: parseFloat(document.getElementById('e-v-val').value), expiryDate: document.getElementById('e-v-exp').value ? new Date(document.getElementById('e-v-exp').value) : null, status: newStatus };
                
                // We are updating a nested field. The logic for approval handles the full object update usually, 
                // but here we need to construct the update data specifically.
                const updateData = { personalVoucher: newVouch };
                saveDataWithApproval("users", uid, updateData, { personalVoucher: v }, `Edited voucher ${newCode}`);
            });
        }
        async function markRedeem(uid, code) {
            if(!confirm(`Mark voucher ${code} as Redeemed?`)) return;
            const userDoc = await db.collection("users").doc(uid).get();
            const uData = userDoc.data();
            const vouch = uData.personalVoucher;
            await db.collection("vouchers_history").doc(code).set({ ...vouch, ownerUid: uid, assignedToName: uData.name, status: "Redeemed", movedAt: firebase.firestore.FieldValue.serverTimestamp() });
            await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
            showToast("Voucher Redeemed", "success");
            logActivity(`Marked voucher ${code} as Redeemed`);
        }
        async function disableVoucher(uid, code) {
            if(!confirm(`Disable voucher ${code}?`)) return;
            const userDoc = await db.collection("users").doc(uid).get();
            const uData = userDoc.data();
            const vouch = uData.personalVoucher;
            await db.collection("vouchers_history").doc(code).set({ ...vouch, ownerUid: uid, assignedToName: uData.name, status: "Disabled", movedAt: firebase.firestore.FieldValue.serverTimestamp() });
            await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
            showToast("Voucher Disabled", "info");
            logActivity(`Disabled voucher ${code}`);
        }
        function openAssignVoucherModal(uid, userName) {
            const promise = uid ? Promise.resolve(null) : db.collection("users").where("role", "==", "user").get();
            promise.then(snap => {
                let userSelect = '';
                if(snap) { userSelect = `<label>Select Client</label><select id="v-user" class="mb-4">${snap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('')}</select>`; } else { userSelect = `<input type="hidden" id="v-user" value="${uid}">`; }
                const autoCode = `GIFT-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
                showModal("Assign Voucher", `
                    ${userSelect}
                    <div class="mb-4"><label>Code</label><input id="v-code" value="${autoCode}"></div>
                    <div class="flex gap-4 mb-4">
                        <div style="flex:1"><label>Type</label><select id="v-val-type"><option value="fixed">Fixed (RM)</option><option value="percent">Percent (%)</option></select></div>
                        <div style="flex:1"><label>Value</label><input type="number" id="v-val"></div>
                    </div>
                    <label>Expiry Date</label><input type="date" id="v-exp" class="mb-4">
                `, `<button class="btn btn-primary" onclick="submitAssignVoucher()">Assign</button>`);
            });
        }
        function submitAssignVoucher() {
            const uid = document.getElementById('v-user').value;
            const code = document.getElementById('v-code').value.toUpperCase();
            db.collection("users").doc(uid).update({ personalVoucher: { code: code, type: document.getElementById('v-val-type').value, value: parseFloat(document.getElementById('v-val').value), expiryDate: document.getElementById('v-exp').value ? new Date(document.getElementById('v-exp').value) : null, status: 'active', auditLog: [{ action: 'Created', by: userData.email, date: new Date().toISOString() }] }}).then(() => { closeModal(); showToast(`Voucher ${code} Assigned!`, "success"); logActivity(`Assigned voucher ${code}`); });
        }
        function restoreVoucher(code, ownerUid) {
            if(!confirm("Restore this voucher?")) return;
            db.collection("vouchers_history").doc(code).get().then(hist => {
                if(!hist.exists) return showToast("Error", "error");
                const v = hist.data();
                db.collection("users").doc(ownerUid).update({ personalVoucher: { ...v, status: 'active' } }).then(() => {
                    db.collection("vouchers_history").doc(code).delete().then(() => { showToast("Voucher Restored", "success"); logActivity(`Restored voucher ${code}`); });
                });
            });
        }

        // --- 7. CONTENT & PACKAGES ---
        function renderContent() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_CONTENT);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Content & Packages</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="saveContentChanges()"><i class="ri-save-line"></i> Save Changes</button>` : ''}
                </div>
                <div class="config-section">
                    <h3 style="margin-bottom:1rem;">Frontend Package Features</h3>
                    <p class="mb-4 text-sm text-muted">Edit feature list displayed on main website. (One feature per line)</p>
                    <textarea id="content-frontend" rows="6" ${canEdit?'':'readonly'}></textarea>
                </div>
                <div class="config-section">
                    <h3 style="margin-bottom:1rem;">AI Package Features</h3>
                    <p class="mb-4 text-sm text-muted">Edit feature list displayed on website. (One feature per line)</p>
                    <textarea id="content-ai" rows="6" ${canEdit?'':'readonly'}></textarea>
                </div>
            `;
            db.collection("config").doc("site_settings").get().then(doc => {
                const siteData = doc.exists ? doc.data() : {};
                const packages = siteData.packageDetails || {};
                const frontendFeatures = (packages.frontend && packages.frontend.features) ? packages.frontend.features : ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"];
                const aiFeatures = (packages.ai && packages.ai.features) ? packages.ai.features : ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"];
                document.getElementById('content-frontend').value = frontendFeatures.join('\n');
                document.getElementById('content-ai').value = aiFeatures.join('\n');
            });
        }
        function saveContentChanges() {
            const frontendLines = document.getElementById('content-frontend').value.split('\n').filter(l => l.trim() !== '');
            const aiLines = document.getElementById('content-ai').value.split('\n').filter(l => l.trim() !== '');
            const btn = document.querySelector('button[onclick="saveContentChanges()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="loading-spinner" style="width:16px; height:16px; border-width:2px;"></div> Saving...`;
            
            // Config is usually global, so auto-approve if admin
            db.collection("config").doc("site_settings").get().then(doc => {
                const data = doc.exists ? doc.data() : {};
                const newPkgDetails = data.packageDetails || {};
                newPkgDetails.frontend = { features: frontendLines };
                newPkgDetails.ai = { features: aiLines };
                
                const updateData = { packageDetails: newPkgDetails };
                saveDataWithApproval("config", "site_settings", updateData, { packageDetails: data.packageDetails }, "Updated Website Content").then(() => {
                     btn.innerHTML = originalHTML;
                });
            }).catch(err => { showToast("Error updating: " + err.message, "error"); btn.innerHTML = originalHTML; });
        }

        // --- 8. CONFIG ---
        function renderConfig() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_CONFIG);
            document.getElementById('main').innerHTML = `
                <h2 style="font-size:1.25rem; font-weight:700; margin-bottom:1.5rem;">System Configuration</h2>
                <div class="config-section">
                    <div class="config-header flex justify-between">
                        <span>Maintenance Mode</span>
                        ${canEdit ? `
                        <label class="toggle-switch">
                            <input type="checkbox" id="maint-toggle" onchange="toggleMaintenance()">
                            <span class="slider"></span>
                        </label>` : `<span class="badge" style="background:var(--bg-input)">Read Only</span>`}
                    </div>
                    <p class="text-muted text-sm mb-4">Toggle a warning banner on main site and restrict access.</p>
                    <div class="mb-4">
                        <label>Maintenance Message</label>
                        <textarea id="maint-msg" class="mb-2" rows="3" ${canEdit?'':'readonly'}>We are currently performing scheduled maintenance.</textarea>
                        ${canEdit ? `<button class="btn btn-sm btn-secondary" onclick="saveMaintMsg()">Update Message</button>` : ''}
                    </div>
                </div>
                <div class="config-section">
                    <div class="config-header">Dynamic Pricing Override</div>
                    <p class="text-muted text-sm mb-4">Base prices for different modules (Syncs with Main Site).</p>
                    <div class="price-grid">
                        <div><label>HTML Package Price</label><div class="flex gap-2"><input id="price-html" type="number" ${canEdit?'':'readonly'}>${canEdit?'<button class="btn btn-primary" onclick="savePrice(\'html\', \'price-html\')">Save</button>':''}</div></div>
                        <div><label>Frontend Package Price</label><div class="flex gap-2"><input id="price-fe" type="number" ${canEdit?'':'readonly'}>${canEdit?'<button class="btn btn-primary" onclick="savePrice(\'frontend\', \'price-fe\')">Save</button>':''}</div></div>
                        <div><label>AI/Data Price (Base)</label><div class="flex gap-2"><input id="price-ai" type="number" ${canEdit?'':'readonly'}>${canEdit?'<button class="btn btn-primary" onclick="savePrice(\'ai\', \'price-ai\')">Save</button>':''}</div></div>
                    </div>
                </div>
                <div class="config-section">
                    <div class="config-header flex justify-between">
                        <span>Payment Gateways</span>
                        ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="addGateway()"><i class="ri-add-line"></i> Add Gateway</button>` : ''}
                    </div>
                    <div id="gateway-list" class="flex flex-col gap-4"></div>
                </div>
            `;
            db.collection("config").doc("site_settings").get().then(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    if(d.maintenance_active) document.getElementById('maint-toggle').checked = true;
                    if(d.maintenance_message) document.getElementById('maint-msg').value = d.maintenance_message;
                    if(d.prices) {
                        if(d.prices.html) document.getElementById('price-html').value = d.prices.html;
                        if(d.prices.frontend) document.getElementById('price-fe').value = d.prices.frontend;
                        if(d.prices.ai) document.getElementById('price-ai').value = d.prices.ai;
                    }
                }
            });
            db.collection("payment_methods").onSnapshot(snap => {
                const list = document.getElementById('gateway-list');
                if(!list) return;
                list.innerHTML = '';
                snap.forEach(doc => {
                    const gw = doc.data();
                    list.innerHTML += `
                        <div class="gateway-card">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="color:var(--primary)">${gw.name}</strong>
                                <span class="badge ${gw.active?'badge-success':'badge-danger'}" style="${gw.active?'background:rgba(16,185,129,0.1);color:#10b981':'background:rgba(239,68,68,0.1);color:#ef4444'}">${gw.active?'Active':'Inactive'}</span>
                            </div>
                            <div class="text-sm text-muted" style="word-break:break-all;">${gw.link || 'No Link'}</div>
                            ${canEdit ? `
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button class="btn btn-sm btn-secondary" onclick="editGateway('${doc.id}')"><i class="ri-pencil-line"></i></button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleGatewayStatus('${doc.id}')"><i class="ri-refresh-line"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGateway('${doc.id}')"><i class="ri-delete-bin-line"></i></button>
                            </div>` : ''}
                        </div>`;
                });
            });
        }
        function toggleMaintenance() { 
             const isActive = document.getElementById('maint-toggle').checked;
             saveDataWithApproval("config", "site_settings", { maintenance_active: isActive }, { maintenance_active: !isActive }, `Toggled Maintenance to ${isActive ? 'On' : 'Off'}`).then(() => {
                 showToast(`Maintenance Mode ${isActive ? 'Enabled' : 'Disabled'}`, isActive?'warning':'success'); 
             });
        }
        function saveMaintMsg() { 
            const msg = document.getElementById('maint-msg').value;
            saveDataWithApproval("config", "site_settings", { maintenance_message: msg }, { maintenance_message: "" }, "Updated Maintenance Message").then(() => showToast("Message Saved", "success"));
        }
        function savePrice(key, elemId) { 
            const theVal = parseFloat(document.getElementById(elemId).value);
            if(!theVal) return showToast("Invalid price", "error");
            const updateObj = {}; updateObj[`prices.${key}`] = theVal;
            saveDataWithApproval("config", "site_settings", updateObj, { prices: {} }, `Updated Price for ${key}`).then(() => showToast("Price Updated", "success"));
        }
        function addGateway() { 
            showModal("Add Payment Gateway", `<label>Gateway Name</label><input id="gw-name" class="mb-4"><label>Payment Link / URL</label><input id="gw-link" class="mb-4">`, `<button class="btn btn-primary" onclick="saveNewGateway()">Add</button>`); 
        }
        async function saveNewGateway() { 
            const name = document.getElementById('gw-name').value; const link = document.getElementById('gw-link').value;
            await db.collection("payment_methods").add({ name, link, active: true }); closeModal(); showToast("Gateway Added", "success"); logActivity(`Added payment gateway: ${name}`);
        }
        function editGateway(docId) { 
            db.collection("payment_methods").doc(docId).get().then(doc => { const gw = doc.data(); showModal("Edit Payment Gateway", `<label>Gateway Name</label><input id="e-gw-name" value="${gw.name}" class="mb-4"><label>Payment Link / URL</label><input id="e-gw-link" value="${gw.link}" class="mb-4">`, `<button class="btn btn-primary" onclick="saveEditedGateway('${docId}')">Save</button>`); }); 
        }
        async function saveEditedGateway(docId) { 
            const name = document.getElementById('e-gw-name').value; const link = document.getElementById('e-gw-link').value;
            const newData = { name, link };
            const oldData = (await db.collection("payment_methods").doc(docId).get()).data();
            saveDataWithApproval("payment_methods", docId, newData, oldData, `Edited Gateway ${name}`).then(() => { renderConfig(); });
        }
        async function toggleGatewayStatus(docId) { 
            const docRef = await db.collection("payment_methods").doc(docId).get(); const currentStatus = docRef.data().active;
            saveDataWithApproval("payment_methods", docId, { active: !currentStatus }, { active: currentStatus }, `Toggled Gateway Status`).then(() => { renderConfig(); });
        }
        async function deleteGateway(docId) { 
            if(!confirm("Delete gateway?")) return; 
            await db.collection("payment_methods").doc(docId).delete(); renderConfig(); 
        }

        // --- 9. PORTFOLIO MANAGEMENT ---
        function renderPortfolio() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_PORTFOLIO);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Client Portfolio</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="openAddPortfolioModal()"><i class="ri-add-line"></i> Add Project</button>` : ''}
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>Projects (clients_portfolio)</h3></div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Thumbnail</th><th>Project Name</th><th>Website Link</th><th>Status</th><th>Actions</th></tr></thead><tbody id="portfolio-tbody"><tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    </div>
                </div>
            `;
            db.collection("clients_portfolio").orderBy("timestamp", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('portfolio-tbody');
                if(!tbody) return;
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No portfolio projects found.</td></tr>'; return; }
                tbody.innerHTML = snap.docs.map(doc => {
                    const p = doc.data();
                    const statusBadge = p.status ? `<span class="badge" style="background:var(--success)15; color:var(--success); border:1px solid var(--success)25">Active</span>` : `<span class="badge" style="background:var(--text-faint); color:var(--text-muted); border:1px solid var(--border)">Inactive</span>`;
                    let actions = '';
                    if (canEdit) {
                        actions = `<button class="btn btn-sm btn-secondary" onclick="editPortfolio('${doc.id}')"><i class="ri-pencil-line"></i></button><button class="btn ${p.status ? 'btn-danger' : 'btn-success'}" onclick="togglePortfolioStatus('${doc.id}', ${!p.status})"><i class="${p.status ? 'ri-eye-off-line' : 'ri-eye-line'}"></i></button><button class="btn btn-sm btn-danger" onclick="deletePortfolio('${doc.id}')"><i class="ri-delete-bin-line"></i></button>`;
                    }
                    return `<tr>
                        <td><img src="${p.img}" alt="thumb" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border);" onerror="this.src='https://placehold.co/50?text=No+Img'"></td>
                        <td><strong>${p.name}</strong></td>
                        <td><a href="${p.link}" target="_blank" class="btn btn-sm btn-secondary"><i class="ri-external-link-line"></i> Visit</a></td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            });
        }
        function openAddPortfolioModal() { 
            const initialId = generateDocIdFromName('');
            showModal("Add New Project", `
                <div class="mb-4"><label>Project Name</label><input type="text" id="p-name" placeholder="e.g. Clinic Azam" oninput="updateDocIdPreview()"><small style="color:var(--text-faint)">ID will be generated from name</small></div>
                <div class="mb-4"><label>Generated ID (Auto)</label><input type="text" id="p-doc-id" readonly value="${initialId}" class="font-mono" style="color:var(--primary); background:var(--bg-sidebar);"></div>
                <div class="mb-4"><label>Image URL</label><input type="text" id="p-img" placeholder="https://..."><small style="color:var(--text-faint)">Direct link to image file.</small></div>
                <div class="mb-4"><label>Website Link</label><input type="text" id="p-link" placeholder="https://..."></div>
                <div class="flex items-center gap-4"><label class="toggle-switch"><input type="checkbox" id="p-status" checked><span class="slider"></span></label><span style="font-size:0.9rem; color:var(--text-main);">Visible on Main Site</span></div>
            `, `<button class="btn btn-primary" onclick="saveNewPortfolio()">Create Project</button>`); 
        }
        function saveNewPortfolio() { 
            const name = document.getElementById('p-name').value; const img = document.getElementById('p-img').value; const link = document.getElementById('p-link').value; const status = document.getElementById('p-status').checked; const customId = document.getElementById('p-doc-id').value;
            if(!name || !img || !link) return showToast("Please fill in all fields.", "error");
            db.collection("clients_portfolio").doc(customId).set({ name, img, link, status, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { closeModal(); showToast("Project added successfully", "success"); logActivity(`Added portfolio project: ${name} (ID: ${customId})`); }).catch(err => { showToast("Error: " + err.message, "error"); });
        }
        function editPortfolio(docId) { 
            db.collection("clients_portfolio").doc(docId).get().then(doc => {
                const p = doc.data();
                const isAuto = canAutoApprove();
                const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;
                showModal("Edit Project", `
                    <div class="mb-4"><label>Project Name</label><input type="text" id="e-p-name" value="${p.name}"><small style="color:var(--text-faint)">Editing name does not change ID</small></div>
                    <div class="mb-4"><label>Image URL</label><input type="text" id="e-p-img" value="${p.img}"></div>
                    <div class="mb-4"><label>Website Link</label><input type="text" id="e-p-link" value="${p.link}"></div>
                    <div class="flex items-center gap-4"><label class="toggle-switch"><input type="checkbox" id="e-p-status" ${p.status ? 'checked' : ''}><span class="slider"></span></label><span style="font-size:0.9rem; color:var(--text-main);">Visible on Main Site</span></div>
                    ${footerNote}
                `, `<button class="btn btn-primary" onclick="updatePortfolio('${docId}')">Save Changes</button>`);
            });
        }
        function updatePortfolio(docId) { 
            const updates = { name: document.getElementById('e-p-name').value, img: document.getElementById('e-p-img').value, link: document.getElementById('e-p-link').value, status: document.getElementById('e-p-status').checked };
            db.collection("clients_portfolio").doc(docId).get().then(doc => {
                const original = doc.data();
                saveDataWithApproval("clients_portfolio", docId, updates, original, `Updated Portfolio ${updates.name}`);
            });
        }
        function togglePortfolioStatus(docId, newStatus) { 
            saveDataWithApproval("clients_portfolio", docId, { status: newStatus }, { status: !newStatus }, `${newStatus ? 'Activated' : 'Deactivated'} Project`).then(() => { showToast(`Project ${newStatus ? 'Activated' : 'Deactivated'}`, "info"); });
        }
        function deletePortfolio(docId) { if(!confirm("Are you sure you want to delete this project? This cannot be undone.")) return; db.collection("clients_portfolio").doc(docId).delete().then(() => { showToast("Project deleted", "success"); logActivity(`Deleted portfolio project`); }).catch(err => { showToast("Error deleting: " + err.message, "error"); }); }

        // --- 10. PROFILE ---
        function renderMyProfile() {
            document.getElementById('main').innerHTML = `
                <div class="p-4" style="background:var(--bg-surface); border:1px solid var(--border); border-radius:12px; max-width:500px; margin:0 auto;">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="u-avatar" style="width:50px; height:50px; font-size:1.5rem;">${(userData.name || 'A').charAt(0)}</div>
                        <div>
                            <h2 style="font-size:1.25rem;">${userData.name}</h2>
                            <span class="badge badge-${userData.role==='super_admin'?'admin':(userData.role==='admin'?'admin':'crew')}">${userData.role==='super_admin'?'Super Admin':(userData.role==='admin'?'Admin':'Crew')}</span>
                        </div>
                    </div>
                    <div class="mb-4"><label class="text-muted">Name</label><input value="${userData.name}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Email</label><input value="${userData.email}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Crew ID</label><input value="${userData.crewId || 'N/A'}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Job Title</label><input value="${userData.jobTitle||'N/A'}" readonly></div>
                    <p class="text-center text-muted text-sm mt-4">Profile is read-only.</p>
                </div>`;
        }
        function filterTable(id, text) {
            const trs = document.querySelectorAll(`#${id} tr`);
            text = text.toLowerCase();
            trs.forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(text)?'':'none');
        }

        // --- 11. CUSTOMER REQUESTS ---
        function renderRequests() {
            const canDelete = hasPermission(PERMISSION_KEYS.DELETE_REQUESTS);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Customer Requests</h2>
                    <input type="text" id="reqSearch" placeholder="Search Client..." style="width:200px;" onkeyup="filterTable('req-tbody', this.value)">
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>Date</th><th>Client</th><th>Type</th><th>Summary</th><th>Status</th><th>Action</th></tr></thead><tbody id="req-tbody"><tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    </div>
                </div>
            `;
            db.collection("customer_requests").orderBy("timestamp", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('req-tbody');
                if(!tbody) return;
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No requests found</td></tr>'; return; }
                tbody.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    const type = d.type || 'content';
                    let badgeClass = 'badge-content';
                    let summaryText = '';
                    if(type === 'content') { summaryText = d.details ? d.details.substring(0, 30) + '...' : 'Update Content'; badgeClass = 'badge-content'; } 
                    else if (type === 'upgrade') { summaryText = `${d.currentPlan || 'Old'}  ${d.newPlan || 'New'}`; badgeClass = 'badge-upgrade'; } 
                    else if (type === 'renew') { summaryText = `${d.plan || 'Plan'} (${d.duration || '1yr'})`; badgeClass = 'badge-renew'; } 
                    else if (type === 'remove') { summaryText = d.details ? 'Remove Content' : 'Remove Item'; badgeClass = 'badge-remove'; }
                    const statusColor = d.status === 'Completed' ? 'var(--success)' : 'var(--warning)';
                    
                    let actions = `<button class="btn btn-sm btn-secondary" onclick="viewRequestDetails('${doc.id}')">View</button>`;
                    if (canDelete) {
                        actions += `<button class="btn btn-sm btn-danger" onclick="deleteItem('request','${doc.id}')"><i class="ri-delete-bin-line"></i></button>`;
                    }

                    return `<tr>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td><strong>${d.name}</strong><br><small style="color:var(--text-faint)">${d.phone || ''}</small></td>
                        <td><span class="badge ${badgeClass}">${type.toUpperCase()}</span></td>
                        <td>${summaryText} ${d.hasFile ? '<i class="ri-attachment-line" title="File Attached" style="color:var(--primary)"></i>' : ''}</td>
                        <td><span class="badge" style="background:${statusColor}15; color:${statusColor}; border:1px solid ${statusColor}25">${d.status}</span></td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            });
        }
        function viewRequestDetails(id) {
            db.collection("customer_requests").doc(id).get().then(doc => {
                const d = doc.data();
                const type = d.type;
                let detailsHTML = '';
                if(type === 'content') { detailsHTML = `<div class="mb-4"><label>Description</label><textarea readonly rows="4">${d.details || 'No description provided.'}</textarea></div><div class="mb-4"><label>Attachments</label><div class="flex items-center gap-2 text-sm"><i class="${d.hasFile ? 'ri-checkbox-circle-fill text-success' : 'ri-close-circle-fill text-muted'}"></i>${d.hasFile ? 'User attached a file via website form.' : 'No file attached.'}</div></div>`; } 
                else if (type === 'upgrade') { detailsHTML = `<div class="flex gap-4 mb-4"><div style="flex:1"><label>Current Plan</label><input value="${d.currentPlan || '-'}" readonly></div><div style="flex:1"><label>New Plan</label><input value="${d.newPlan || '-'}" readonly></div></div><div class="mb-4"><label>Additional Notes</label><textarea readonly rows="3">${d.details || '-'}</textarea></div>`; } 
                else if (type === 'renew') { detailsHTML = `<div class="flex gap-4 mb-4"><div style="flex:1"><label>Plan to Renew</label><input value="${d.plan || '-'}" readonly></div><div style="flex:1"><label>Duration</label><input value="${d.duration || '-'}" readonly></div></div>`; } 
                else if (type === 'remove') { detailsHTML = `<div class="mb-4"><label>Items to Remove</label><textarea readonly rows="3">${d.details || '-'}</textarea></div>`; }
                
                const isAuto = canAutoApprove();
                const footerNote = isAuto ? '' : `<small style="color:var(--warning); display:block; margin-top:0.5rem; text-align:center;"><i class="ri-alert-line"></i> Changes require approval.</small>`;

                showModal(`Request Details (${type.toUpperCase()})`, `
                    <div class="mb-4 p-4" style="background:var(--bg-sidebar); border-radius:8px; border:1px solid var(--border)">
                        <div class="text-sm text-muted mb-1">Client Info</div>
                        <strong>${d.name}</strong> (${d.phone})<br>${d.userId ? `<small class="text-muted">User ID: ${d.userId}</small>` : ''}
                    </div>
                    ${detailsHTML}
                    <div class="mt-4"><label>Update Status</label><select id="req-status-select"><option value="Pending" ${d.status==='Pending'?'selected':''}>Pending</option><option value="Completed" ${d.status==='Completed'?'selected':''}>Completed</option></select></div>
                    ${footerNote}
                `, `<button class="btn btn-primary" onclick="updateRequestStatus('${id}', null, true)">Save Status</button>`);
            });
        }
        function updateRequestStatus(id, newStatus = null, fromModal = false) {
            const statusToSet = newStatus || document.getElementById('req-status-select').value;
            db.collection("customer_requests").doc(id).get().then(doc => {
                const original = doc.data();
                saveDataWithApproval("customer_requests", id, { status: statusToSet }, { status: original.status }, `Updated Request Status to ${statusToSet}`).then(() => {
                    if(fromModal) closeModal();
                    showToast("Request Status Updated", "success");
                    logActivity(`Updated request status to ${statusToSet}`);
                });
            });
        }
        function deleteItem(collection, id) {
            if(!hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) return showToast("Access Denied. Only Founder/SuperAdmin can delete.", "error");
            if(!confirm("Delete this item permanently?")) return;
            db.collection(collection).doc(id).delete().then(() => { showToast("Item deleted", "success"); logActivity(`Deleted item from ${collection}`); });
        }

        // --- 12. PUBLIC PROMO CODES ---
        function renderPublicPromos() {
            const canEdit = hasPermission(PERMISSION_KEYS.EDIT_PROMOS);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Public Promo Codes</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="addPublicPromo()"><i class="ri-add-line"></i> Add Code</button>` : ''}
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>Active Codes (config/promo_codes)</h3></div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Code</th><th>Discount (%)</th><th>Action</th></tr></thead><tbody id="public-promos-tbody"><tr><td colspan="3" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    </div>
                </div>
            `;
            db.collection("promo_codes").onSnapshot(snap => {
                const tbody = document.getElementById('public-promos-tbody');
                if(!tbody) return;
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No public promo codes found.</td></tr>'; return; }
                tbody.innerHTML = snap.docs.map(doc => {
                    const code = doc.id; 
                    const data = doc.data();
                    const discountPercent = (data.discount * 100) + '%';
                    let actions = '';
                    if (canEdit) {
                        actions = `<button class="btn btn-sm btn-danger" onclick="deletePublicPromo('${code}')"><i class="ri-delete-bin-line"></i> Delete</button>`;
                    }
                    return `<tr>
                        <td class="font-mono" style="color:var(--warning); font-weight:700;">${code}</td>
                        <td><span class="badge" style="background:var(--success)15; color:var(--success); border:1px solid var(--success)25">${discountPercent}</span></td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            });
        }
        function addPublicPromo() { 
            showModal("Add Public Promo Code", `<div class="mb-4"><label>Promo Code (ID)</label><input type="text" id="pub-promo-code" placeholder="e.g. WELCOME10" style="text-transform:uppercase;"><small class="text-muted">Users will enter this exact code.</small></div><div class="mb-4"><label>Discount Percentage</label><input type="number" id="pub-promo-discount" placeholder="0.1 for 10%"><small class="text-muted">Decimal (e.g., 0.10 = 10%)</small></div>`, `<button class="btn btn-primary" onclick="savePublicPromo()">Create Code</button>`); 
        }
        async function savePublicPromo() { 
            const code = document.getElementById('pub-promo-code').value.trim().toUpperCase(); const discount = parseFloat(document.getElementById('pub-promo-discount').value);
            if(!code || isNaN(discount)) return showToast("Invalid Input", "error");
            try { await db.collection("promo_codes").doc(code).set({ discount: discount }); closeModal(); showToast("Promo Code Created", "success"); logActivity(`Created public promo code: ${code}`); } catch(e) { showToast("Error: " + e.message, "error"); }
        }
        async function deletePublicPromo(code) { 
            if(!confirm(`Delete promo code ${code}?`)) return; 
            try { await db.collection("promo_codes").doc(code).delete(); showToast("Promo Code Deleted", "success"); logActivity(`Deleted public promo code: ${code}`); } catch(e) { showToast("Error deleting: " + e.message, "error"); } 
        }

        // --- 13. COMMISSIONS (Finance) ---
        async function renderCommissions() {
            // Check specific Finance access
            const isFinance = userData.jobTitle && userData.jobTitle.includes("Finance");
            if(!isFinance && !isFounder() && !isSuperAdmin()) {
                document.getElementById('main').innerHTML = `
                    <div class="access-denied-container">
                        <div class="access-denied-icon"><i class="ri-lock-2-line"></i></div>
                        <div class="access-denied-title">Access Denied</div>
                        <div class="access-denied-desc">This module is restricted to Finance Executives, Founder, and Super Admins only.</div>
                    </div>`;
                return;
            }

            const canEditFinance = hasPermission(PERMISSION_KEYS.EDIT_FINANCE);
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">My Commissions</h2>
                    <button class="btn btn-secondary" onclick="renderCommissions()"><i class="ri-refresh-line"></i> Refresh</button>
                </div>
                <div class="stats-grid" id="comm-stats">
                    <div class="page-loader"><div class="loading-spinner"></div></div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>Payout Ledger (Paid Orders Only)</h3>
                        ${isSuperAdmin() || canEditFinance ? '<small class="text-muted">Finance View: Seeing all commissions.</small>' : '<small class="text-muted">Viewing your assigned sales only.</small>'}
                    </div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Order Ref</th><th>Package</th><th>Amount</th><th>Type</th><th>My Cut</th></tr></thead><tbody id="comm-tbody"><tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    </div>
                </div>
            `;
            const myUid = currentUser.uid;
            const ordersSnap = await db.collection("orders").where("status", "==", "Paid").get();
            const ordersList = ordersSnap.docs.map(d => ({id: d.id, ...d.data()}));
            let totalEarnings = 0;
            let commDetails = [];
            ordersList.forEach(order => {
                let commission = 0;
                const amount = parseFloat(order.total.replace('RM ', '')) || 0;
                const cycle = (order.billingCycle || 'One-Time').toLowerCase();
                if (isSuperAdmin() || canEditFinance) {
                    commission = amount * 0.05; 
                    commDetails.push({ ref: order.id.substring(0,6), pkg: order.package, amt: amount, cycle: cycle, comm: commission });
                } else {
                    const reps = order.salesRepIds || [];
                    const oldRep = order.salesRepId;
                    if(reps.includes(myUid) || oldRep === myUid) {
                        const myRate = userData.commissionRate || 0;
                        commission = amount * myRate;
                        commDetails.push({ ref: order.id.substring(0,6), pkg: order.package, amt: amount, cycle: cycle, comm: commission });
                    }
                }
                totalEarnings += commission;
            });
            document.getElementById('comm-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon" style="color:var(--success); background:var(--success)15"><i class="ri-wallet-3-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-val">RM ${totalEarnings.toFixed(2)}</div>
                        <div class="stat-label">Total Pending Payouts</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="color:var(--primary); background:var(--primary)15"><i class="ri-file-list-3-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-val">${commDetails.length}</div>
                        <div class="stat-label">Eligible Transactions</div>
                    </div>
                </div>
                ${isSuperAdmin() || canEditFinance ? `
                <div class="stat-card">
                    <div class="stat-icon" style="color:var(--warning); background:var(--warning)15"><i class="ri-vip-crown-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-val">Finance View</div>
                        <div class="stat-label">Global Commission Overview</div>
                    </div>
                </div>` : `
                <div class="stat-card">
                    <div class="stat-icon" style="color:var(--info); background:var(--info)15"><i class="ri-user-star-line"></i></div>
                    <div class="stat-info">
                        <div class="stat-val">${(userData.commissionRate*100).toFixed(1)}%</div>
                        <div class="stat-label">My Rate</div>
                    </div>
                </div>`}
            `;
            const tbody = document.getElementById('comm-tbody');
            if(commDetails.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No commissions found.</td></tr>`;
            } else {
                tbody.innerHTML = commDetails.map(c => `
                    <tr>
                        <td class="font-mono" style="color:var(--primary)">${c.ref}</td>
                        <td>${c.pkg}</td>
                        <td>RM ${c.amt}</td>
                        <td><span class="badge badge-crew" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); text-transform:capitalize;">${c.cycle}</span></td>
                        <td style="color:var(--success); font-weight:700;">+ RM ${c.comm.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
        }

        // --- 14. APPROVAL TOOLS (NEW & UPDATED) ---
        function renderApprovals() {
            if(!hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) {
                document.getElementById('main').innerHTML = `<div class="access-denied-container"><div class="access-denied-title">Access Denied</div><div class="access-denied-desc">You do not have permission to view this page.</div></div>`;
                return;
            }

            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.5rem; font-weight:700; color: var(--warning);"><i class="ri-shield-check-line"></i> Approval Tools</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="color:var(--warning); background:rgba(245,158,11,0.15)"><i class="ri-time-line"></i></div>
                        <div class="stat-info">
                            <div class="stat-val" id="count-pending">0</div>
                            <div class="stat-label">Pending Edits</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>Pending Approvals</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Requester</th>
                                    <th>Target</th>
                                    <th>Context</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvals-tbody">
                                <tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Listen for PENDING_EDITS
            db.collection("pending_edits").where("status", "==", "Pending").orderBy("requestedAt", "desc").onSnapshot(snap => {
                const tbody = document.getElementById('approvals-tbody');
                const counter = document.getElementById('count-pending');
                if(!tbody) return;

                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No pending requests</td></tr>';
                    if(counter) counter.innerText = "0";
                    return;
                }

                if(counter) counter.innerText = snap.size;

                tbody.innerHTML = snap.docs.map(doc => {
                    const r = doc.data();
                    
                    // Create a human readable target name
                    let targetName = `${r.targetCollection}/${r.targetDocId}`;
                    if(r.targetCollection === 'users' && r.originalData) targetName = `User: ${r.originalData.name || r.originalData.email || r.targetDocId}`;
                    if(r.targetCollection === 'orders' && r.originalData) targetName = `Order: #${r.targetDocId.substr(0,6)}`;
                    if(r.targetCollection === 'tickets' && r.originalData) targetName = `Ticket: ${r.originalData.ticketId || r.targetDocId}`;

                    return `<tr>
                        <td style="white-space:nowrap;">${formatDateTime(r.requestedAt)}</td>
                        <td>
                            <strong>${r.requesterName}</strong><br>
                            <small class="text-muted">${r.requesterEmail}</small>
                        </td>
                        <td class="text-sm font-mono" style="color:var(--text-muted);">${targetName}</td>
                        <td>
                            <div class="text-sm font-bold" style="color:var(--primary);">${r.context}</div>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="reviewApproval('${doc.id}')">Review</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        // Review Modal
        async function reviewApproval(requestId) {
            const doc = await db.collection("pending_edits").doc(requestId).get();
            if(!doc.exists) return;
            const r = doc.data();

            // Generate Diff View
            let diffHTML = '<div class="diff-viewer">';
            for (const key in r.newData) {
                const oldVal = r.originalData[key];
                const newVal = r.newData[key];
                
                // Simple JSON stringify for objects, simple string for others
                const oldStr = (typeof oldVal === 'object') ? JSON.stringify(oldVal) : String(oldVal);
                const newStr = (typeof newVal === 'object') ? JSON.stringify(newVal) : String(newVal);

                diffHTML += `
                    <div class="diff-label">${key}</div>
                    <div class="diff-field old">${oldStr || '<em>(empty)</em>'}</div>
                    <div class="diff-field new">${newStr || '<em>(empty)</em>'}</div>
                `;
            }
            diffHTML += '</div>';

            showModal(`Review: ${r.context}`, `
                <div class="mb-4 text-sm text-muted">
                    Requested by <strong>${r.requesterName}</strong> on ${formatDateTime(r.requestedAt)}.
                </div>
                <h4 style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.5rem; text-transform:uppercase;">Changes Preview</h4>
                ${diffHTML}
            `, `
                <button class="btn btn-danger" onclick="rejectApproval('${requestId}')">Reject</button>
                <button class="btn btn-success" onclick="approveApproval('${requestId}')">Approve</button>
            `);
        }

        async function approveApproval(requestId) {
            if(!confirm("Are you sure you want to approve these changes? The database will be updated immediately.")) return;

            try {
                const doc = await db.collection("pending_edits").doc(requestId).get();
                const r = doc.data();

                // 1. Execute the update on the real collection
                await db.collection(r.targetCollection).doc(r.targetDocId).update(r.newData);

                // 2. Mark the request as Approved
                await db.collection("pending_edits").doc(requestId).update({
                    status: 'Approved',
                    processedBy: userData.name,
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal();
                showToast("Changes Approved & Saved", "success");
                logActivity(`Approved request: ${r.context} by ${r.requesterName}`);
            } catch(e) {
                console.error(e);
                showToast("Error approving: " + e.message, "error");
            }
        }

        async function rejectApproval(requestId) {
            // Prompt for reason
            const reason = prompt("Please provide a reason for rejection (optional):");
            
            try {
                await db.collection("pending_edits").doc(requestId).update({
                    status: 'Rejected',
                    rejectionReason: reason || "No reason provided",
                    processedBy: userData.name,
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal();
                showToast("Request Rejected", "warning");
                logActivity(`Rejected request from user`);
            } catch(e) {
                showToast("Error rejecting: " + e.message, "error");
            }
        }

    </script>
</body>
</html>
